#' @title  Visualize multigroups model results
#' @description VizMulGroupsCros function is mainly aimed to visualize the modeling results calculated by MulGroupsCros function.
#'     It can provide plots with high quality of the final results to make it easier for users to understand.
#' @usage eSet = VizMulGroupsCros(eSet = eSet,VarsY = c("Y1"),NodeNum = 100,EdgeThr = 0.5,
#'                        Layout = "force-directed",Brightness = "light",Palette = "default1")
#' @param eSet An R6 class object.
#' @param VarsY chr. Outcome variable for modeling. Only one variable can be entered.
#' @param NodeNum num. Number of nodes in the network plot. The maximum number is generated by multigroups function.
#'     User can set a smaller value if needed.
#' @param EdgeThr num. Threshold of correlation coefficient ranging 0-1 for generating the concerned edges of the network plot.
#' @param Layout chr. Visualization layout. Available options include "force-directed" and "degree-circle".
#' @param Brightness chr. Visualization brightness. Available options include "light" and "dark".
#' @param Palette chr. Visualization palette. Available options include "default1", "default2" and other options about some
#' journal preference styles including "cell", "nature", "science", "lancet", "nejm", etc.
#' @param Mode ggraph
#' @details You can get different styles of images by selecting different parameters.
#' @return An R6 class object containing seven elements. The elements of that object include:
#' (1) "Importance_plot": Plots for the importance of features after modeling a single group from different learners.
#' (2) "Measures_boxplot": Plots for the r-square value of the single group model built by different learners.
#' (3) "NetWork_State": A list containing dataframes that contain nodes and edges used to draw
#'     intergroup network from models built by different learners.
#' (4) "Nodeplot": Intergroup node plots from models built by different models.
#' (5) "Networkplot": Intergroup network plots from models built by different models.
#' (6) "Prediction_train_plot": Plots for the prediction value of the train set in the SG model built by different combinations of learners.
#' (7) "Prediction_test_plot": Plots for the prediction value of the test set in the SG model built by different combinations of learners.
#' @export
#' @examples
#'    eSet = InitEX(PID = "EX", FileDirIn = "default", FileDirOut = "default")
#' eSet = LoadEX(eSet = eSet,UseExample = "default",FileDirExpo = "examdata.xlsx",FileDirVoca = "examvoca.xlsx")
#' eSet = TransImput(eSet = eSet,Group = T,Vars = "all.e",Method = "lod")
#' eSet = DelLowVar(eSet = eSet)
#' eSet = DelMiss(eSet = eSet)
#' eSet = TransType(eSet = eSet,Vars = c("Y1", "C1","E203","E204","E207","E209"),TypeTo = "factor")
#' eSet = TransScale(eSet = eSet,Group = T,Vars = "all.e",Method = "normal",
#'                   Direct = "positive",RangeLow = 0,RangeUpper = 1)
#' eSet = TransDistr(eSet = eSet,Vars = c("C2", "C3"), Method = "log2")
#' eSet = TransDummy(eSet = eSet,Vars = "default")
#' eSet = MulGroupsCros(eSet = eSet,Groups = c("Exposure","Biomarker"),
#'                     VarsY = c("Y1"),VarsC = "all.c",TuneMethod = "grid_search",TuneNum = 5,RsmpMethod = "cv",
#'                     Folds = 5,VarsImpThr = 0.85,SG_Lrns = c("rf","xgboost"))
#' eSet = VizMulGroupsCros(eSet = eSet,VarsY = c("Y1"),NodeNum = 100,EdgeThr = 0.5,
#'                        Layout = "force-directed",Brightness = "light",Palette = "default1")
#' @author Guohuan Zhang, Yuting Wang, Ning Gao, Bin Wang (corresponding author)

VizMulGroupsCros <- function(eSet,
                            VarsY,
                            NodeNum,
                            EdgeThr,
                            Mode = "ggraph",
                            Layout = "force-directed",
                            Brightness = "light",
                            Palette = 'cell'
){
  tictoc::tic()

  OmicGroups <- eSet$MulOmics$OmicGroup.all
  SG_Lrns <- eSet$MulOmics$Max_NodeNum$Learners
  # Map OmicGroups-----------------------
  lubridate::now() %>%
    stringr::str_replace_all(":",".") %>%
    stringr::str_replace_all("-",".") -> NowTime
  message(stringr::str_c("Visualizing model on Single Omic layer...",NowTime))
  eSet$ExcecutionLog  <- eSet$AddLog(stringr::str_c("Visualizing model on Single Omic layer...",NowTime))
  # Define Viz omic process ----------------------------------------------------
  VizOmic <- function(OmicGroup,
                      eSet,
                      VarsY,
                      SG_Lrns){
    Path = stringr::str_c(eSet$FileDirOut)
    if(!file.exists(Path)) {dir.create(Path)}
    Var.type <- eSet$Expo$Data[[VarsY]] %>% class()
    switch(Var.type,
           "factor"={measure_key = "classif.acc"},
           "numeric"={measure_key = "regr.rsq"}
    )
    # Measures ----------------------------------------------------
    # Benchmark
    eSet$MulOmics[[OmicGroup]]$Models$Measures$bmr %>%
      autoplot(type = "boxplot",
               measure = msr(measure_key)) -> boxplot
    boxplot$facet$params$nrow = 1
    boxplot %>%
      ggplot2::ggsave(filename = stringr::str_c(Path,"/1_",
                                                OmicGroup,
                                                "/Model_Summary/Measures_boxplot.png"),
                      width = 10,
                      height = 3.5)

    boxplot %>%
      ggplot2::ggsave(filename = stringr::str_c(Path,"/1_",
                                                OmicGroup,
                                                "/Model_Summary/Measures_boxplot.svg"),
                      width = 10,
                      height = 3.5)

    # Explain ----------------------------------------------------
    # Importance
    # Lasso
    if("lasso" %in% SG_Lrns){
      eSet$MulOmics[[OmicGroup]]$Models$Explainer$importance_lasso %>%
        plot()+
        theme(plot.background = element_rect(fill = 'white'))+
        ggtitle("Feature Importance (TOP 10)",
                "") -> importance_ls_plot
      importance_ls_plot$data %<>%
        arrange(desc(dropout_loss.x)) %>% head(10)
      importance_ls_plot %>%
        ggplot2::ggsave(filename = stringr::str_c(Path,"/1_",
                                                  OmicGroup,
                                                  "/Feature_Explain/Lasso/Importance_lasso_plot.png"),
                        width = 6,
                        height = 7)

      importance_ls_plot %>%
        ggplot2::ggsave(filename = stringr::str_c(Path,"/1_",
                                                  OmicGroup,
                                                  "/Feature_Explain/Lasso/Importance_lasso_plot.svg"),
                        width = 6,
                        height = 7)
    }
    # Elastic net
    if("enet" %in% SG_Lrns){
      eSet$MulOmics[[OmicGroup]]$Models$Explainer$importance_enet %>%
        plot()+
        theme(plot.background = element_rect(fill = 'white'))+
        ggtitle("Feature Importance (TOP 10)",
                "") -> importance_en_plot
      importance_en_plot$data %<>%
        arrange(desc(dropout_loss.x)) %>% head(10)
      importance_en_plot %>%
        ggplot2::ggsave(filename = stringr::str_c(Path,"/1_",
                                                  OmicGroup,
                                                  "/Feature_Explain/ElasticNet/Importance_enet_plot.png"),
                        width = 6,
                        height = 7)

      importance_en_plot %>%
        ggplot2::ggsave(filename = stringr::str_c(Path,"/1_",
                                                  OmicGroup,
                                                  "/Feature_Explain/ElasticNet/Importance_enet_plot.svg"),
                        width = 6,
                        height = 7)

    }
    # Random Forest
    if("rf" %in% SG_Lrns){
      eSet$MulOmics[[OmicGroup]]$Models$Explainer$importance_rf %>%
        plot()+
        theme(plot.background = element_rect(fill = 'white'))+
        ggtitle("Feature Importance (TOP 10)",
                "") -> importance_rf_plot
      importance_rf_plot$data %<>%
        arrange(desc(dropout_loss.x)) %>% head(10)
      importance_rf_plot %>%
        ggplot2::ggsave(filename = stringr::str_c(Path,"/1_",
                                                  OmicGroup,
                                                  "/Feature_Explain/RandomForest/Importance_rf_plot.png"),
                        width = 6,
                        height = 7)

      importance_rf_plot %>%
        ggplot2::ggsave(filename = stringr::str_c(Path,"/1_",
                                                  OmicGroup,
                                                  "/Feature_Explain/RandomForest/Importance_rf_plot.svg"),
                        width = 6,
                        height = 7)

    }
    # Xgboost
    if("xgboost" %in% SG_Lrns){
      eSet$MulOmics[[OmicGroup]]$Models$Explainer$importance_xgboost %>%
        plot()+
        theme(plot.background = element_rect(fill = 'white'))+
        ggtitle("Feature Importance (TOP 10)",
                "") -> importance_xgboost_plot
      importance_xgboost_plot$data %<>%
        arrange(desc(dropout_loss.x)) %>% head(10)
      importance_xgboost_plot %>%
        ggplot2::ggsave(filename = stringr::str_c(Path,"/1_",
                                                  OmicGroup,
                                                  "/Feature_Explain/Xgboost/Importance_xgboost_plot.png"),
                        width = 6,
                        height = 7)

      importance_xgboost_plot %>%
        ggplot2::ggsave(filename = stringr::str_c(Path,"/1_",
                                                  OmicGroup,
                                                  "/Feature_Explain/Xgboost/Importance_xgboost_plot.svg"),
                        width = 6,
                        height = 7)

    }

    # # Partial-dependence plot
    # # Define Partial-dependence plot function
    # Pdp <- function(Feature,
    #                 Expl,
    #                 modelname){
    #   DALEX::model_profile(explainer = Expl,
    #                        variables = Feature) %>%
    #     plot(geom = "profiles")+
    #     theme(plot.background = element_rect(fill = 'white'))
    #   ggplot2::ggsave(filename = stringr::str_c(Path,"/1_",
    #                                             OmicGroup,
    #                                             "/Feature_Explain/",
    #                                             modelname,
    #                                             "/Pdp_",
    #                                             modelname,"_",
    #                                             Feature,
    #                                             ".png"),
    #                   width = 6,
    #                   height = 6)
    # }
    # # Lasso Partial-dependence plot
    # if("Lasso" %in% SG_Lrns){
    # map(importance_ls_plot$data$variable %>% as.character(),
    #     Pdp,
    #     Expl = eSet$MulOmics[[OmicGroup]]$Models$Explainer$expl_lasso,
    #     modelname = "Lasso")}
    # # Elastic net Partial-dependence plot
    # if("ElasticNet" %in% SG_Lrns){
    # map(importance_en_plot$data$variable %>% as.character(),
    #     Pdp,
    #     Expl = eSet$MulOmics[[OmicGroup]]$Models$Explainer$expl_elasticnet,
    #     modelname = "Elastic net")}
    # # Random forest Partial-dependence plot
    # if("RandomForest" %in% SG_Lrns){
    # map(importance_rf_plot$data$variable %>% as.character(),
    #     Pdp,
    #     Expl = eSet$MulOmics[[OmicGroup]]$Models$Explainer$expl_rf,
    #     modelname = "Randomforest")}
    # # Xgboost Partial-dependence plot
    # if("Xgboost" %in% SG_Lrns){
    # map(importance_xgboost_plot$data$variable %>% as.character(),
    #     Pdp,
    #     Expl = eSet$MulOmics[[OmicGroup]]$Models$Explainer$expl_xgboost,
    #     modelname = "Xgboost")}

  }
  map(OmicGroups,
      VizOmic,
      eSet = eSet,
      VarsY = VarsY,
      SG_Lrns = SG_Lrns)
  # Viz SG -----------------------------
  lubridate::now() %>%
    stringr::str_replace_all(":",".") %>%
    stringr::str_replace_all("-",".") -> NowTime
  message(stringr::str_c("Visualizing model on Stacking layer...",NowTime))
  eSet$ExcecutionLog  <- eSet$AddLog(stringr::str_c("Visualizing model on Stacking layer...",NowTime))

  # Viz prediction
  # Define Viz SG  process----------------------------------------------------
  VizSG <- function(SGer,
                    eSet,
                    VarsY){
    Path = stringr::str_c(eSet$FileDirOut)
    if(!file.exists(Path)) {dir.create(Path)}
    PTplot = function(baselrn,
                      SGer,
                      VarsY){
      # Training
      eSet$MulOmics$SG[[SGer]]$y_y.pred[[baselrn]]$train %>%
        ggplot(aes(x = True.Y.Train, y = Pred.Y.Train))+
        geom_point(shape = 1, color = "black", size = 1.5)+
        geom_smooth(method='lm', formula = y~x, se=F, color='black',linewidth = 0.4)+
        ggpubr::stat_cor(method="pearson",color='black',p.accuracy=0.001,
                         label.x.npc="middle",label.y.npc="bottom")+
        labs(title = str_c("Training (N = ",nrow(eSet$MulOmics$SG[[SGer]]$y_y.pred[[baselrn]]$train),")"),
             x = eSet$Expo$Voca %>% dplyr::filter(SerialNo==VarsY) %>% dplyr::select(FullName),
             y = str_c("Predicted ",eSet$Expo$Voca %>% dplyr::filter(SerialNo==VarsY) %>% dplyr::select(FullName)))+
        theme_classic()+
        theme(plot.title = element_text(size=12,hjust=0.5))
      ggplot2::ggsave(filename = str_c(Path,"/2_SG/Viz_Prediction/",
                                       baselrn," ",SGer,"_Training.png"),
                      width = 6,
                      height = 6)

      ggplot2::ggsave(filename = str_c(Path,"/2_SG/Viz_Prediction/",
                                       baselrn," ",SGer,"_Training.svg"),
                      width = 6,
                      height = 6)

      # Test
      eSet$MulOmics$SG[[SGer]]$y_y.pred[[baselrn]]$test %>%
        ggplot(aes(x = True.Y.Test, y = Pred.Y.Test))+
        geom_point(shape = 1, color = "black", size = 1.5)+
        geom_smooth(method='lm', formula = y~x, se=F, color='black',linewidth = 0.4)+
        ggpubr::stat_cor(method="pearson",color='black',p.accuracy=0.001,
                         label.x.npc="middle",label.y.npc="bottom")+
        labs(title = str_c("Test (N = ",nrow(eSet$MulOmics$SG[[SGer]]$y_y.pred[[baselrn]]$test),")"),
             x = eSet$Expo$Voca %>% dplyr::filter(SerialNo==VarsY) %>% dplyr::select(FullName),
             y = str_c("Predicted ",eSet$Expo$Voca %>% dplyr::filter(SerialNo==VarsY) %>% dplyr::select(FullName)))+
        theme_classic()+
        theme(plot.title = element_text(size=12,hjust=0.5))
      ggplot2::ggsave(filename = str_c(Path,"/2_SG/Viz_Prediction/",
                                       baselrn," ",SGer,"_Test.png"),
                      width = 6,
                      height = 6)

      ggplot2::ggsave(filename = str_c(Path,"/2_SG/Viz_Prediction/",
                                       baselrn," ",SGer,"_Test.svg"),
                      width = 6,
                      height = 6)

    }
    baselrns = eSet$MulOmics$SG[[SGer]]$y_y.pred %>% names()
    map(baselrns,
        PTplot,
        SGer = SGer,
        VarsY = VarsY)
  }
  map(eSet$MulOmics$SG %>% names,
      VizSG,
      eSet = eSet,
      VarsY = VarsY)
  # Generate Networks data--------------------
  # Intra-network data
  # lubridate::now() %>%
  #   stringr::str_replace_all(":",".") %>%
  #   stringr::str_replace_all("-",".") -> NowTime
  # message(stringr::str_c("Generating Format for Intraomic Network...Please Be Patient!",NowTime))
  # eSet$ExcecutionLog  <- eSet$AddLog(stringr::str_c("Generating Format for Intraomic Network...Please Be Patient!",NowTime))
  # source("functions/IntraNetData.R")
  # map(OmicGroups,
  #     IntraNetData,
  #     VarY = VarsY,
  #     NodeNum = NodeNum)
  # Inter-network data
  message(stringr::str_c("Generating Format for Interomic Network...Please Be Patient!",NowTime))
  eSet$ExcecutionLog  <- eSet$AddLog(stringr::str_c("Generating Format for Interomic Network...Please Be Patient!",NowTime))

  InterNetData = function(inter_Lrn,
                          VarY,
                          NodeNum,
                          EdgeThr,
                          eSet){
    Path = stringr::str_c(eSet$FileDirOut)
    OmicGroups <- eSet$MulOmics$OmicGroup.all
    SG_Lrns <- eSet$MulOmics$Max_NodeNum$Learners

    switch (inter_Lrn,
            "lasso" = {
              # lasso
              map(OmicGroups,
                  ~names((dplyr::select(eSet$Expo$Data %>% dplyr::filter(Group=="train"),
                                        eSet$MulOmics[[.]]$Features$features_selected$lasso)))) -> fs.temp
              fs=NULL
              for(i in 1:length(fs.temp)){
                fs <- union(fs,fs.temp[[i]])
              }
              eSet$Expo$Data %>% dplyr::filter(Group=="train") %>%
                dplyr::select(all_of(fs)) %>%
                bind_cols(eSet$Expo$Data %>%
                            dplyr::filter(Group=="train") %>%
                            dplyr::select(VarY)) %>%
                as.matrix() %>%
                rcorr(type = "pearson") -> corr.dt.lasso
              #
              corr.dt.lasso$r %>%
                as.data.frame() %>%
                rownames_to_column() %>%
                dplyr::rename(source = rowname) %>%
                pivot_longer(-source,
                             names_to = "target",
                             values_to = "R") %>%
                rownames_to_column() -> R.mat.lasso

              corr.dt.lasso$P %>%
                as.data.frame() %>%
                rownames_to_column() %>%
                dplyr::rename(source = rowname) %>%
                pivot_longer(-source,
                             names_to = "target",
                             values_to = "P") %>%
                rownames_to_column() -> P.mat.lasso
              # node lasso
              P.mat.lasso %>%
                dplyr::filter(source==VarY&target!=VarY) %>%
                dplyr::select(-rowname,
                              -source) %>%
                dplyr::rename(SerialNo = target) %>%
                dplyr::mutate(P = map_dbl(SerialNo,
                                          ~(cor.test(dplyr::select(eSet$Expo$Data %>% dplyr::filter(Group=="train"),
                                                                   all_of(.)) %>% as.matrix() %>% as.numeric(),
                                                     dplyr::select(eSet$Expo$Data %>% dplyr::filter(Group=="train"),
                                                                   all_of(VarY)) %>% as.matrix() %>% as.numeric(),
                                                     method = "pearson")$p.value))) -> Node.lasso
              map_dfr(OmicGroups,
                      ~(eSet$MulOmics[[.]]$Features$Coef$lasso)) %>%
                right_join(Node.lasso,
                           by = "SerialNo") %>%
                dplyr::mutate(MinusLog10P = map_dbl(P,
                                                    ~(-log10(.))),
                              ModelIndex = map2_dbl(Coef,
                                                    MinusLog10P,
                                                    ~(abs(.x)*.y))) %>%
                dplyr::arrange(desc(ModelIndex)) %>%
                head(NodeNum) %>%
                dplyr::mutate(label = map_chr(SerialNo,
                                              ~(dplyr::filter(eSet$Expo$Voca,
                                                              SerialNo==.) %>%
                                                  dplyr::select(FullName) %>%
                                                  as.matrix() %>%
                                                  as.vector())),
                              group = map_chr(SerialNo,
                                              ~(dplyr::filter(eSet$Expo$Voca,
                                                              SerialNo==.) %>%
                                                  dplyr::select(GroupName) %>%
                                                  as.matrix() %>%
                                                  as.vector()))) %>%
                dplyr::rename(id = SerialNo) %>%
                dplyr::select(id,
                              group,
                              label,
                              Coef,
                              P,
                              MinusLog10P,
                              ModelIndex) -> eSet$MulOmics$NetWork$Stat$lasso$node

              eSet$MulOmics$NetWork$Stat$lasso$node %>%
                writexl::write_xlsx(str_c(Path,"/2_SG/Viz_InterOmic/Node_Step1.by.lasso.xlsx"))
              # edge lasso
              eSet$MulOmics$NetWork$Stat$lasso$node %>%
                dplyr::select(id) %>%
                as.matrix() %>%
                as.vector() -> Node.var.lasso

              R.mat.lasso %>%
                dplyr::left_join(P.mat.lasso %>%
                                   dplyr::select(rowname,P),
                                 by = "rowname") %>%
                dplyr::filter(source!=VarY&target!=VarY) %>%
                dplyr::filter(source%in%Node.var.lasso&target%in%Node.var.lasso) %>%
                dplyr::filter(P < 0.05/length(Node.var.lasso)) %>% # choose the concerned correlations
                dplyr::filter(abs(R) > EdgeThr) %>%
                dplyr::select(-rowname)  %>%
                dplyr::mutate(interaction = "Corr.pearson",
                              source.label = map_chr(source,
                                                     ~(dplyr::filter(eSet$Expo$Voca,
                                                                     SerialNo==.) %>%
                                                         dplyr::select(FullName) %>%
                                                         as.matrix() %>%
                                                         as.vector())),
                              target.label = map_chr(target,
                                                     ~(dplyr::filter(eSet$Expo$Voca,
                                                                     SerialNo==.) %>%
                                                         dplyr::select(FullName) %>%
                                                         as.matrix() %>%
                                                         as.vector())),
                              database = "Selected Features",
                              edge_type = case_when(R > 0 ~ "1",
                                                    R < 0 ~ "2")
                ) %>%
                dplyr::select(source,
                              target,
                              interaction,
                              source.label,
                              target.label,
                              database,
                              edge_type,
                              R,
                              P) -> eSet$MulOmics$NetWork$Stat$lasso$edge

              eSet$MulOmics$NetWork$Stat$lasso$edge %>%
                writexl::write_xlsx(str_c(Path,"/2_SG/Viz_InterOmic/Edge_Step1.by.lasso.xlsx"))
            },
            "enet" = {
              # elasticnet
              map(OmicGroups,
                  ~names((dplyr::select(eSet$Expo$Data %>% dplyr::filter(Group=="train"),
                                        eSet$MulOmics[[.]]$Features$features_selected$enet)))) -> fs.temp
              fs=NULL
              for(i in 1:length(fs.temp)){
                fs <- union(fs,fs.temp[[i]])
              }
              eSet$Expo$Data %>% dplyr::filter(Group=="train") %>%
                dplyr::select(all_of(fs)) %>%
                bind_cols(eSet$Expo$Data %>%
                            dplyr::filter(Group=="train") %>%
                            dplyr::select(VarY)) %>%
                as.matrix() %>%
                rcorr(type = "pearson") -> corr.dt.enet
              #
              corr.dt.enet$r %>%
                as.data.frame() %>%
                rownames_to_column() %>%
                dplyr::rename(source = rowname) %>%
                pivot_longer(-source,
                             names_to = "target",
                             values_to = "R") %>%
                rownames_to_column() -> R.mat.enet

              corr.dt.enet$P %>%
                as.data.frame() %>%
                rownames_to_column() %>%
                dplyr::rename(source = rowname) %>%
                pivot_longer(-source,
                             names_to = "target",
                             values_to = "P") %>%
                rownames_to_column() -> P.mat.enet
              # node elasticnet
              P.mat.enet %>%
                dplyr::filter(source==VarY&target!=VarY) %>%
                dplyr::select(-rowname,
                              -source) %>%
                dplyr::rename(SerialNo = target) %>%
                dplyr::mutate(P = map_dbl(SerialNo,
                                          ~(cor.test(dplyr::select(eSet$Expo$Data %>% dplyr::filter(Group=="train"),
                                                                   all_of(.)) %>% as.matrix() %>% as.numeric(),
                                                     dplyr::select(eSet$Expo$Data %>% dplyr::filter(Group=="train"),
                                                                   all_of(VarY)) %>% as.matrix() %>% as.numeric(),
                                                     method = "pearson")$p.value))) -> Node.enet
              map_dfr(OmicGroups,
                      ~(eSet$MulOmics[[.]]$Features$Coef$enet)) %>%
                right_join(Node.enet,
                           by = "SerialNo") %>%
                dplyr::mutate(MinusLog10P = map_dbl(P,
                                                    ~(-log10(.))),
                              ModelIndex = map2_dbl(Coef,
                                                    MinusLog10P,
                                                    ~(abs(.x)*.y))) %>%
                dplyr::arrange(desc(ModelIndex)) %>%
                head(NodeNum) %>%
                dplyr::mutate(label = map_chr(SerialNo,
                                              ~(dplyr::filter(eSet$Expo$Voca,
                                                              SerialNo==.) %>%
                                                  dplyr::select(FullName) %>%
                                                  as.matrix() %>%
                                                  as.vector())),
                              group = map_chr(SerialNo,
                                              ~(dplyr::filter(eSet$Expo$Voca,
                                                              SerialNo==.) %>%
                                                  dplyr::select(GroupName) %>%
                                                  as.matrix() %>%
                                                  as.vector()))) %>%
                dplyr::rename(id = SerialNo) %>%
                dplyr::select(id,
                              group,
                              label,
                              Coef,
                              P,
                              MinusLog10P,
                              ModelIndex) -> eSet$MulOmics$NetWork$Stat$enet$node

              eSet$MulOmics$NetWork$Stat$enet$node %>%
                writexl::write_xlsx(str_c(Path,"/2_SG/Viz_InterOmic/Node_Step1.by.enet.xlsx"))
              # edge elasticnet
              eSet$MulOmics$NetWork$Stat$enet$node %>%
                dplyr::select(id) %>%
                as.matrix() %>%
                as.vector() -> Node.var.enet

              R.mat.enet %>%
                dplyr::left_join(P.mat.enet %>%
                                   dplyr::select(rowname,P),
                                 by = "rowname") %>%
                dplyr::filter(source!=VarY&target!=VarY) %>%
                dplyr::filter(source%in%Node.var.enet&target%in%Node.var.enet) %>%
                dplyr::filter(P < 0.05/length(Node.var.enet)) %>% # choose the concerned correlations
                dplyr::filter(abs(R) > EdgeThr) %>%
                dplyr::select(-rowname)  %>%
                dplyr::mutate(interaction = "Corr.pearson",
                              source.label = map_chr(source,
                                                     ~(dplyr::filter(eSet$Expo$Voca,
                                                                     SerialNo==.) %>%
                                                         dplyr::select(FullName) %>%
                                                         as.matrix() %>%
                                                         as.vector())),
                              target.label = map_chr(target,
                                                     ~(dplyr::filter(eSet$Expo$Voca,
                                                                     SerialNo==.) %>%
                                                         dplyr::select(FullName) %>%
                                                         as.matrix() %>%
                                                         as.vector())),
                              database = "Selected Features",
                              edge_type = case_when(R > 0 ~ "1",
                                                    R < 0 ~ "2")
                ) %>%
                dplyr::select(source,
                              target,
                              interaction,
                              source.label,
                              target.label,
                              database,
                              edge_type,
                              R,
                              P) -> eSet$MulOmics$NetWork$Stat$enet$edge

              eSet$MulOmics$NetWork$Stat$enet$edge %>%
                writexl::write_xlsx(str_c(Path,"/2_SG/Viz_InterOmic/Edge_Step1.by.enet.xlsx"))
            },
            "rf" = {
              # rf
              map(OmicGroups,
                  ~names((dplyr::select(eSet$Expo$Data %>% dplyr::filter(Group=="train"),
                                        eSet$MulOmics[[.]]$Features$features_selected$rf)))) -> fs.temp
              fs=NULL
              for(i in 1:length(fs.temp)){
                fs <- union(fs,fs.temp[[i]])
              }
              eSet$Expo$Data %>% dplyr::filter(Group=="train") %>%
                dplyr::select(all_of(fs)) %>%
                bind_cols(eSet$Expo$Data %>%
                            dplyr::filter(Group=="train") %>%
                            dplyr::select(VarY)) %>%
                as.matrix() %>%
                rcorr(type = "pearson") -> corr.dt.rf
              #
              corr.dt.rf$r %>%
                as.data.frame() %>%
                rownames_to_column() %>%
                dplyr::rename(source = rowname) %>%
                pivot_longer(-source,
                             names_to = "target",
                             values_to = "R") %>%
                rownames_to_column() -> R.mat.rf

              corr.dt.rf$P %>%
                as.data.frame() %>%
                rownames_to_column() %>%
                dplyr::rename(source = rowname) %>%
                pivot_longer(-source,
                             names_to = "target",
                             values_to = "P") %>%
                rownames_to_column() -> P.mat.rf
              # node rf
              P.mat.rf %>%
                dplyr::filter(source==VarY&target!=VarY) %>%
                dplyr::select(-rowname,
                              -source) %>%
                dplyr::rename(SerialNo = target) %>%
                dplyr::mutate(P = map_dbl(SerialNo,
                                          ~(cor.test(dplyr::select(eSet$Expo$Data %>% dplyr::filter(Group=="train"),
                                                                   all_of(.)) %>% as.matrix() %>% as.numeric(),
                                                     dplyr::select(eSet$Expo$Data %>% dplyr::filter(Group=="train"),
                                                                   all_of(VarY)) %>% as.matrix() %>% as.numeric(),
                                                     method = "pearson")$p.value))) -> Node.rf
              map_dfr(OmicGroups,
                      ~(eSet$MulOmics[[.]]$Features$feature_importance$rf %>% dplyr::select(SerialNo,importance))) %>%
                right_join(Node.rf,
                           by = "SerialNo") %>%
                dplyr::mutate(MinusLog10P = map_dbl(P,
                                                    ~(-log10(.))),
                              ModelIndex = map2_dbl(importance,
                                                    MinusLog10P,
                                                    ~(abs(.x)*.y))) %>%
                dplyr::arrange(desc(ModelIndex)) %>%
                head(NodeNum) %>%
                dplyr::mutate(label = map_chr(SerialNo,
                                              ~(dplyr::filter(eSet$Expo$Voca,
                                                              SerialNo==.) %>%
                                                  dplyr::select(FullName) %>%
                                                  as.matrix() %>%
                                                  as.vector())),
                              group = map_chr(SerialNo,
                                              ~(dplyr::filter(eSet$Expo$Voca,
                                                              SerialNo==.) %>%
                                                  dplyr::select(GroupName) %>%
                                                  as.matrix() %>%
                                                  as.vector()))) %>%
                dplyr::rename(id = SerialNo) %>%
                dplyr::select(id,
                              group,
                              label,
                              importance,
                              P,
                              MinusLog10P,
                              ModelIndex)-> eSet$MulOmics$NetWork$Stat$rf$node

              eSet$MulOmics$NetWork$Stat$rf$node %>%
                writexl::write_xlsx(str_c(Path,"/2_SG/Viz_InterOmic/Node_Step1.by.rf.xlsx"))
              # edge rf
              eSet$MulOmics$NetWork$Stat$rf$node %>%
                dplyr::select(id) %>%
                as.matrix() %>%
                as.vector() -> Node.var.rf

              R.mat.rf %>%
                dplyr::left_join(P.mat.rf %>%
                                   dplyr::select(rowname,P),
                                 by = "rowname") %>%
                dplyr::filter(source!=VarY&target!=VarY) %>%
                dplyr::filter(source%in%Node.var.rf&target%in%Node.var.rf) %>%
                dplyr::filter(P < 0.05/length(Node.var.rf)) %>% # choose the concerned correlations
                dplyr::filter(abs(R) > EdgeThr) %>%
                dplyr::select(-rowname)  %>%
                dplyr::mutate(interaction = "Corr.pearson",
                              source.label = map_chr(source,
                                                     ~(dplyr::filter(eSet$Expo$Voca,
                                                                     SerialNo==.) %>%
                                                         dplyr::select(FullName) %>%
                                                         as.matrix() %>%
                                                         as.vector())),
                              target.label = map_chr(target,
                                                     ~(dplyr::filter(eSet$Expo$Voca,
                                                                     SerialNo==.) %>%
                                                         dplyr::select(FullName) %>%
                                                         as.matrix() %>%
                                                         as.vector())),
                              database = "Selected Features",
                              edge_type = case_when(R > 0 ~ "1",
                                                    R < 0 ~ "2")
                ) %>%
                dplyr::select(source,
                              target,
                              interaction,
                              source.label,
                              target.label,
                              database,
                              edge_type,
                              R,
                              P) -> eSet$MulOmics$NetWork$Stat$rf$edge

              eSet$MulOmics$NetWork$Stat$rf$edge %>%
                writexl::write_xlsx(str_c(Path,"/2_SG/Viz_InterOmic/Edge_Step1.by.rf.xlsx"))
            },
            "xgboost" = {
              # xgboost
              map(OmicGroups,
                  ~names((dplyr::select(eSet$Expo$Data %>% dplyr::filter(Group=="train"),
                                        eSet$MulOmics[[.]]$Features$features_selected$xgboost)))) -> fs.temp
              fs=NULL
              for(i in 1:length(fs.temp)){
                fs <- union(fs,fs.temp[[i]])
              }
              eSet$Expo$Data %>% dplyr::filter(Group=="train") %>%
                dplyr::select(all_of(fs)) %>%
                bind_cols(eSet$Expo$Data %>%
                            dplyr::filter(Group=="train") %>%
                            dplyr::select(VarY)) %>%
                as.matrix() %>%
                rcorr(type = "pearson") -> corr.dt.xgboost
              #
              corr.dt.xgboost$r %>%
                as.data.frame() %>%
                rownames_to_column() %>%
                dplyr::rename(source = rowname) %>%
                pivot_longer(-source,
                             names_to = "target",
                             values_to = "R") %>%
                rownames_to_column() -> R.mat.xgboost

              corr.dt.xgboost$P %>%
                as.data.frame() %>%
                rownames_to_column() %>%
                dplyr::rename(source = rowname) %>%
                pivot_longer(-source,
                             names_to = "target",
                             values_to = "P") %>%
                rownames_to_column() -> P.mat.xgboost
              # node xgboost
              P.mat.xgboost %>%
                dplyr::filter(source==VarY&target!=VarY) %>%
                dplyr::select(-rowname,
                              -source) %>%
                dplyr::rename(SerialNo = target) %>%
                dplyr::mutate(P = map_dbl(SerialNo,
                                          ~(cor.test(dplyr::select(eSet$Expo$Data %>% dplyr::filter(Group=="train"),
                                                                   all_of(.)) %>% as.matrix() %>% as.numeric(),
                                                     dplyr::select(eSet$Expo$Data %>% dplyr::filter(Group=="train"),
                                                                   all_of(VarY)) %>% as.matrix() %>% as.numeric(),
                                                     method = "pearson")$p.value))) -> Node.xgboost
              map_dfr(OmicGroups,
                      ~(eSet$MulOmics[[.]]$Features$feature_importance$xgboost %>% dplyr::select(SerialNo,importance))) %>%
                right_join(Node.xgboost,
                           by = "SerialNo") %>%
                dplyr::mutate(MinusLog10P = map_dbl(P,
                                                    ~(-log10(.))),
                              ModelIndex = map2_dbl(importance,
                                                    MinusLog10P,
                                                    ~(abs(.x)*.y))) %>%
                dplyr::arrange(desc(ModelIndex)) %>%
                head(NodeNum) %>%
                dplyr::mutate(label = map_chr(SerialNo,
                                              ~(dplyr::filter(eSet$Expo$Voca,
                                                              SerialNo==.) %>%
                                                  dplyr::select(FullName) %>%
                                                  as.matrix() %>%
                                                  as.vector())),
                              group = map_chr(SerialNo,
                                              ~(dplyr::filter(eSet$Expo$Voca,
                                                              SerialNo==.) %>%
                                                  dplyr::select(GroupName) %>%
                                                  as.matrix() %>%
                                                  as.vector()))) %>%
                dplyr::rename(id = SerialNo) %>%
                dplyr::select(id,
                              group,
                              label,
                              importance,
                              P,
                              MinusLog10P,
                              ModelIndex) -> eSet$MulOmics$NetWork$Stat$xgboost$node

              eSet$MulOmics$NetWork$Stat$xgboost$node %>%
                writexl::write_xlsx(str_c(Path,"/2_SG/Viz_InterOmic/Node_Step1.by.xgboost.xlsx"))
              # edge xgboost
              eSet$MulOmics$NetWork$Stat$xgboost$node %>%
                dplyr::select(id) %>%
                as.matrix() %>%
                as.vector() -> Node.var.xgboost

              R.mat.xgboost %>%
                dplyr::left_join(P.mat.xgboost %>%
                                   dplyr::select(rowname,P),
                                 by = "rowname") %>%
                dplyr::filter(source!=VarY&target!=VarY) %>%
                dplyr::filter(source%in%Node.var.xgboost&target%in%Node.var.xgboost) %>%
                dplyr::filter(P < 0.05/length(Node.var.xgboost)) %>% # choose the concerned correlations
                dplyr::filter(abs(R) > EdgeThr) %>%
                dplyr::select(-rowname)  %>%
                dplyr::mutate(interaction = "Corr.pearson",
                              source.label = map_chr(source,
                                                     ~(dplyr::filter(eSet$Expo$Voca,
                                                                     SerialNo==.) %>%
                                                         dplyr::select(FullName) %>%
                                                         as.matrix() %>%
                                                         as.vector())),
                              target.label = map_chr(target,
                                                     ~(dplyr::filter(eSet$Expo$Voca,
                                                                     SerialNo==.) %>%
                                                         dplyr::select(FullName) %>%
                                                         as.matrix() %>%
                                                         as.vector())),
                              database = "Selected Features",
                              edge_type = case_when(R > 0 ~ "1",
                                                    R < 0 ~ "2")
                ) %>%
                dplyr::select(source,
                              target,
                              interaction,
                              source.label,
                              target.label,
                              database,
                              edge_type,
                              R,
                              P) -> eSet$MulOmics$NetWork$Stat$xgboost$edge

              eSet$MulOmics$NetWork$Stat$xgboost$edge %>%
                writexl::write_xlsx(str_c(Path,"/2_SG/Viz_InterOmic/Edge_Step1.by.xgboost.xlsx"))

            },
    )}
  map(eSet$MulOmics$Max_NodeNum$Learners,
      InterNetData,
      VarY = VarsY,
      NodeNum = NodeNum,
      EdgeThr = EdgeThr,
      eSet = eSet)

  lubridate::now() %>%
    stringr::str_replace_all(":",".") %>%
    stringr::str_replace_all("-",".") -> NowTime
  message(stringr::str_c("Format for Interomic Network Generated!",NowTime))
  eSet$ExcecutionLog  <- eSet$AddLog(stringr::str_c("Format for Interomic Network Generated!",NowTime))
  # Viz Networks--------------------
  switch(Mode,
         'cytoscape' = {
           eSet$MulOmics$OmicGroup.all -> OmicGroups
           c("ELLIPS",
             "DIAMOND",
             "TRIANGLE",
             "HEXAGON",
             "ROUND_RECTANGLE",
             "OCTAGON",
             "PARALLELOGRAM",
             "V")[1:length(OmicGroups)] -> NdSp
           # Viz Intraomic Networks------------
           # lubridate::now() %>%
           #   stringr::str_replace_all(":",".") %>%
           #   stringr::str_replace_all("-",".") -> NowTime
           # message(stringr::str_c("Visualizing Intraomic Networks...",NowTime))
           # eSet$ExcecutionLog  <- eSet$AddLog(stringr::str_c("Visualizing Intraomic Networks...",NowTime))
           # source("functions/VizOmicNet.R")
           # map2(OmicGroups,
           #      NdSp,
           #      VizOmicNet,
           #      eSet = eSet,
           #      VarY = VarY,
           #      Layout = Layout,
           #      Brightness = Brightness,
           #      Palette = Palette)
           # Viz All Networks-----------------
           lubridate::now() %>%
             stringr::str_replace_all(":",".") %>%
             stringr::str_replace_all("-",".") -> NowTime
           message(stringr::str_c("Visualizing Interomic Networks...",NowTime))
           eSet$ExcecutionLog  <- eSet$AddLog(stringr::str_c("Visualizing Interomic Networks...",NowTime))
           VizAllNet <- function(eSet,
                                 VarsY,
                                 Layout,
                                 Brightness,
                                 Palette){
             lubridate::now() %>%
               stringr::str_replace_all(":",".") %>%
               stringr::str_replace_all("-",".") -> NowTime

             SG_Lrns <- eSet$MulOmics$Max_NodeNum$Learners

             Path = stringr::str_c(eSet$FileDirOut)
             if(!file.exists(Path)) {dir.create(Path)}
             ColorPre <- NULL
             # bright
             c("#FBD266","#8FB0A9","#D76735","#2FA3DC","#F9776A","#F2D8B3","#00b283","#df408a") -> ColorPre[["light_cell"]]
             c("#f39b7f","#4DBBD5","#E64B35","#495e8F","#00A087","#FB3C04","#FF9646","#69CCBB") -> ColorPre[["light_nature"]]
             c("#B85798","#20B2AA","#EE0000","#ffb367","#F06B49","#60C9FF","#F5B2AC","#ECC2F1") -> ColorPre[["light_science"]]
             c("#FFB366","#0099B4","#ED0000","#925E9F","#42b540","#fdaf91","#0297d9","#ff6347") -> ColorPre[["light_lancet"]]
             c("#E18727","#4A91C5","#EE4C97","#8ED14B","#F5B2AC","#F06B49","#ECC2F1","#82C7C3") -> ColorPre[["light_nejm"]]
             c("#79af97","#00A1D5","#FF4D00","#FFA54F","#66CDAA","#9370DB","#DC143C","#E6B800") -> ColorPre[["light_jama"]]
             # dark
             c("#8B7366","#2F375B","#A23419","#be9619","#8e0f00","#13506d","#874338", "#EFD78D") -> ColorPre[["dark_cell"]]
             c("#8B7500","#3C5488","#A51526","#8491B4","#CD3D32","#00A087","#e69966","#7ab8cc") -> ColorPre[["dark_nature"]]
             c("#631879","#3B4992","#A20056","#CD6601","#89363A","#076B82","#bb0021","#1B9F2E") -> ColorPre[["dark_science"]]
             c("#925E9F","#00468B","#AD002A","#db6024","#ADB6B6", "#00808c","#800080","#16982b") -> ColorPre[["dark_lancet"]]
             c("#6F99AD","#533085","#A52A2A","#2A52BE","#cc7722","#1E003C","#076B82","#1B9F2E") -> ColorPre[["dark_nejm"]]
             c("#6A6599","#374e55","#b24745","#02567A","#DF8F44","#cc5500","#8fbc8f","#80796b") -> ColorPre[["dark_jama"]]


             # Set edges and nodes
             if("lasso" %in% SG_Lrns){
               eSet$MulOmics$NetWork$Stat$lasso$edge -> edges.ls
               eSet$MulOmics$NetWork$Stat$lasso$node -> nodes.ls

               if(!file.exists(str_c(Path,"/2_SG/Viz_InterOmic/Lasso"))){
                 dir.create(str_c(Path,"/2_SG/Viz_InterOmic/Lasso"))}
             }

             if("enet" %in% SG_Lrns){
               eSet$MulOmics$NetWork$Stat$enet$edge -> edges.en
               eSet$MulOmics$NetWork$Stat$enet$node -> nodes.en

               if(!file.exists(str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet"))){
                 dir.create(str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet"))}
             }

             if("rf" %in% SG_Lrns){
               eSet$MulOmics$NetWork$Stat$rf$edge -> edges.rf
               eSet$MulOmics$NetWork$Stat$rf$node -> nodes.rf

               if(!file.exists(str_c(Path,"/2_SG/Viz_InterOmic/RandomForest"))){
                 dir.create(str_c(Path,"/2_SG/Viz_InterOmic/RandomForest"))}
             }

             if("xgboost" %in% SG_Lrns){
               eSet$MulOmics$NetWork$Stat$xgboost$edge -> edges.xgb
               eSet$MulOmics$NetWork$Stat$xgboost$node -> nodes.xgb

               if(!file.exists(str_c(Path,"/2_SG/Viz_InterOmic/Xgboost"))){
                 dir.create(str_c(Path,"/2_SG/Viz_InterOmic/Xgboost"))}
             }



             func_save_net <- function(name){
               if(name == "lasso"){name1 = "Lasso"}
               if(name == "enet"){name1 = "ElasticNet"}
               if(name == "rf"){name1 = "RandomForest"}
               if(name == "xgboost"){name1 = "Xgboost"}
               ddpcr::quiet(
                 switch(Layout,
                        "force-directed" = {
                          layoutNetwork(Layout)
                          saveSession(stringr::str_c(Path,"/2_SG/Viz_InterOmic/",name1,"/force-directed_",
                                                     name,"_",Brightness,"_",Palette,"_", NowTime))
                          exportImage(stringr::str_c(Path,"/2_SG/Viz_InterOmic/",name1,"/force-directed_",
                                                     name,"_",Brightness,"_",Palette,"_", NowTime),
                                      overwriteFile = T,
                                      type = "PNG",
                                      zoom=500)
                          exportImage(stringr::str_c(Path,"/2_SG/Viz_InterOmic/",name1,"/force-directed_",
                                                     name,"_",Brightness,"_",Palette,"_", NowTime),
                                      overwriteFile = T,
                                      type = "SVG",
                                      zoom=500)
                        },
                        "degree-circle" = {
                          layoutNetwork(Layout)
                          saveSession(stringr::str_c(Path,"/2_SG/Viz_InterOmic/",name1,"/degree-circle_",
                                                     name,"_",Brightness,"_",Palette,"_", NowTime))
                          exportImage(stringr::str_c(Path,"/2_SG/Viz_InterOmic/",name1,"/degree-circle_",
                                                     name,"_",Brightness,"_",Palette,"_", NowTime),
                                      overwriteFile = T,
                                      type = "PNG",
                                      zoom=500)
                          exportImage(stringr::str_c(Path,"/2_SG/Viz_InterOmic/",name1,"/degree-circle_",
                                                     name,"_",Brightness,"_",Palette,"_", NowTime),
                                      overwriteFile = T,
                                      type = "SVG",
                                      zoom=500)
                        }
                        )
               )
             }
             ggNdSp <- c(18,16,17,15,25,10,7,8)

             # ls--------------------------------------------------------
             if("lasso" %in% SG_Lrns){
               nodes.ls$Coef %>% abs() %>% quantile(probs = seq(0,1,0.2)) %>% .[2] -> labThr
               nodes.ls$Coef %>% abs() %>% quantile(probs = seq(0,1,0.25)) %>% .[4] -> labThr2
               nodes.ls %<>%
                 mutate(labelsize = case_when(abs(Coef) >= labThr ~ 20,
                                              abs(Coef) < labThr ~ 0),
                        labelsize2 = case_when(abs(Coef) >= labThr2 ~ 20,
                                               abs(Coef) < labThr2 ~ 0),
                        absCoef = abs(Coef))

               nodes.ls %>%
                 ggplot(aes(x=Coef,y=MinusLog10P))+
                 geom_point(aes(size=MinusLog10P,shape=group,color=Coef))+
                 scale_shape_manual(values = ggNdSp)+
                 scale_y_continuous(limits = c(0,max(nodes.ls$MinusLog10P)))+
                 geom_vline(xintercept = 0,
                            color = "grey",
                            size = 0.1)+
                 geom_hline(yintercept = -log10(0.05),
                            color = "grey",
                            size = 0.1)+
                 scale_size_continuous("-Log10P")+
                 ggrepel::geom_text_repel(data = subset(nodes.ls,
                                                        nodes.ls$labelsize2!=0),
                                          aes(label=id),
                                          box.padding = unit(0.5, "lines"),
                                          point.padding = unit(1, "lines"), segment.color = "grey50",
                                          show.legend = FALSE,max.overlaps = 20)+
                 labs(y="-Log10P")+
                 theme_bw()+
                 theme(panel.grid=element_blank()) -> NodePlot_ls

               RCy3::cytoscapePing()
               closeSession(F)
               RCy3::createNetworkFromDataFrames(nodes.ls,
                                                 edges.ls,
                                                 title = "network-lasso",
                                                 collection = "network")
               # set style--------------------------------------------------------
               style = "Style1"
               defaults <- list(NODE_SHAPE="ELLIPS",NODE_SIZE=20,
                                EDGE_TRANSPARENCY=50,EDGE_WIDTH=0.5,NODE_LABEL_POSITION="S,W,c,0.00,0.00")
               nodeLabels <- mapVisualProperty('node label','id','p')
               nodeSize <- mapVisualProperty('Node Size','MinusLog10P',"c",
                                             c(nodes.ls$MinusLog10P %>% min(),
                                               nodes.ls$MinusLog10P %>% median(),
                                               nodes.ls$MinusLog10P %>% max()),
                                             c(5, 10, 20))

               nodeLableFontSize <- mapVisualProperty('Node Label Font Size','labelsize',"p")
               createVisualStyle(style,
                                 defaults,
                                 list(nodeLabels,
                                      nodeSize,
                                      nodeLableFontSize))
               setVisualStyle(style)
               switch(Brightness,
                      "light" = {
                        switch(Palette,
                               "cell" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.ls$group %>% unique(),
                                                     ColorPre$light_cell,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.ls$group %>% unique(),
                                                          ColorPre$light_cell,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_ls+
                                   scale_color_gradient2(low = "#64acbf",high = "#ff8033")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Lasso/NodePlot_lasso_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "nature" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.ls$group %>% unique(),
                                                     ColorPre$light_nature,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.ls$group %>% unique(),
                                                          ColorPre$light_nature,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_ls+
                                   scale_color_gradient2(low = "#4DBBD5",high = "#ff0000")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Lasso/NodePlot_lasso_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "science" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.ls$group %>% unique(),
                                                     ColorPre$light_science,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.ls$group %>% unique(),
                                                          ColorPre$light_science,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_ls+
                                   scale_color_gradient2(low = "#20B2AA",high = "#EE0000")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Lasso/NodePlot_lasso_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "lancet" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.ls$group %>% unique(),
                                                     ColorPre$light_lancet,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.ls$group %>% unique(),
                                                          ColorPre$light_lancet,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_ls+
                                   scale_color_gradient2(low = "#0099B4",high = "#ED0000")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Lasso/NodePlot_lasso_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "nejm" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.ls$group %>% unique(),
                                                     ColorPre$light_nejm,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.ls$group %>% unique(),
                                                          ColorPre$light_nejm,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_ls+
                                   scale_color_gradient2(low = "#5A9F77",high = "#EE4C97")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Lasso/NodePlot_lasso_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "jama" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.ls$group %>% unique(),
                                                     ColorPre$light_jama,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.ls$group %>% unique(),
                                                          ColorPre$light_jama,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_ls+
                                   scale_color_gradient2(low = "#79af97",high = "#ff4d00")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Lasso/NodePlot_lasso_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               }
                        )
                      },
                      "dark" = {
                        switch(Palette,
                               "cell" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.ls$group %>% unique(),
                                                     ColorPre$dark_cell,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.ls$group %>% unique(),
                                                          ColorPre$dark_cell,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_ls+
                                   scale_color_gradient2(low = "#323695",high = "#A51526")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Lasso/NodePlot_lasso_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "nature" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.ls$group %>% unique(),
                                                     ColorPre$dark_nature,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.ls$group %>% unique(),
                                                          ColorPre$dark_nature,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 Palette = "nature"
                                 NodePlot_ls+
                                   scale_color_gradient2(low = "#3C5488",high = "#A51526")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Lasso/NodePlot_lasso_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "science" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.ls$group %>% unique(),
                                                     ColorPre$dark_science,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.ls$group %>% unique(),
                                                          ColorPre$dark_science,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_ls+
                                   scale_color_gradient2(low = "#191970",high = "#bb0021")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Lasso/NodePlot_lasso_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "lancet" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.ls$group %>% unique(),
                                                     ColorPre$dark_lancet,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.ls$group %>% unique(),
                                                          ColorPre$dark_lancet,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_ls+
                                   scale_color_gradient2(low = "#00468B",high = "#AD002A")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Lasso/NodePlot_lasso_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)

                               },
                               "nejm" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.ls$group %>% unique(),
                                                     ColorPre$dark_nejm,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.ls$group %>% unique(),
                                                          ColorPre$dark_nejm,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_ls+
                                   scale_color_gradient2(low = "#6F99AD",high = "#A52A2A")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Lasso/NodePlot_lasso_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "jama" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.ls$group %>% unique(),
                                                     ColorPre$dark_jama,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.ls$group %>% unique(),
                                                          ColorPre$dark_jama,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_ls+
                                   scale_color_gradient2(low = "#64acbf",high = "#b24745")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Lasso/NodePlot_lasso_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               }
                        )
                      })
               # save the image
               if(Brightness != "all" & Palette != "all"){
                 func_save_net("lasso")
               }
             }

             # en--------------------------------------------------------
             if("enet" %in% SG_Lrns){
               nodes.en$Coef %>% abs() %>% quantile(probs = seq(0,1,0.2)) %>% .[2] -> labThr
               nodes.en$Coef %>% abs() %>% quantile(probs = seq(0,1,0.25)) %>% .[4] -> labThr2
               nodes.en %<>%
                 mutate(labelsize = case_when(abs(Coef) >= labThr ~ 20,
                                              abs(Coef) < labThr ~ 0),
                        labelsize2 = case_when(abs(Coef) >= labThr2 ~ 20,
                                               abs(Coef) < labThr2 ~ 0),
                        absCoef = abs(Coef))

               nodes.en %>%
                 ggplot(aes(x=Coef,y=MinusLog10P))+
                 geom_point(aes(size=MinusLog10P,shape=group,color=Coef))+
                 scale_shape_manual(values = ggNdSp)+
                 scale_y_continuous(limits = c(0,max(nodes.en$MinusLog10P)))+
                 geom_vline(xintercept = 0,
                            color = "grey",
                            size = 0.1)+
                 geom_hline(yintercept = -log10(0.05),
                            color = "grey",
                            size = 0.1)+
                 scale_size_continuous("-Log10P")+
                 ggrepel::geom_text_repel(data = subset(nodes.en,
                                                        nodes.en$labelsize2!=0),
                                          aes(label=id),
                                          box.padding = unit(0.5, "lines"),
                                          point.padding = unit(1, "lines"), segment.color = "grey50",
                                          show.legend = FALSE,max.overlaps = 20)+
                 labs(y="-Log10P")+
                 theme_bw()+
                 theme(panel.grid=element_blank()) -> NodePlot_en

               RCy3::cytoscapePing()
               closeSession(F)
               RCy3::createNetworkFromDataFrames(nodes.en,
                                                 edges.en,
                                                 title = "network-enet",
                                                 collection = "network")
               # set style--------------------------------------------------------
               style = "Style1"
               defaults <- list(NODE_SHAPE="ELLIPS",NODE_SIZE=20,
                                EDGE_TRANSPARENCY=50,EDGE_WIDTH=0.5,NODE_LABEL_POSITION="S,W,c,0.00,0.00")
               nodeLabels <- mapVisualProperty('node label','id','p')
               nodeSize <- mapVisualProperty('Node Size','MinusLog10P',"c",
                                             c(nodes.en$MinusLog10P %>% min(),
                                               nodes.en$MinusLog10P %>% median(),
                                               nodes.en$MinusLog10P %>% max()),
                                             c(5, 10, 20))

               nodeLableFontSize <- mapVisualProperty('Node Label Font Size','labelsize',"p")


               createVisualStyle(style,
                                 defaults,
                                 list(nodeLabels,
                                      nodeSize,
                                      nodeLableFontSize
                                 ))
               setVisualStyle(style)
               switch(Brightness,
                      "light" = {
                        switch(Palette,
                               "cell" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.en$group %>% unique(),
                                                     ColorPre$light_cell,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.en$group %>% unique(),
                                                          ColorPre$light_cell,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_en+
                                   scale_color_gradient2(low = "#64acbf",high = "#ff8033")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet/NodePlot_enet_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "nature" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.en$group %>% unique(),
                                                     ColorPre$light_nature,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.en$group %>% unique(),
                                                          ColorPre$light_nature,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_en+
                                   scale_color_gradient2(low = "#4DBBD5",high = "#ff0000")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet/NodePlot_enet_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "science" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.en$group %>% unique(),
                                                     ColorPre$light_science,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.en$group %>% unique(),
                                                          ColorPre$light_science,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_en+
                                   scale_color_gradient2(low = "#20B2AA",high = "#EE0000")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet/NodePlot_enet_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "lancet" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.en$group %>% unique(),
                                                     ColorPre$light_lancet,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.en$group %>% unique(),
                                                          ColorPre$light_lancet,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_en+
                                   scale_color_gradient2(low = "#0099B4",high = "#ED0000")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet/NodePlot_enet_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "nejm" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.en$group %>% unique(),
                                                     ColorPre$light_nejm,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.en$group %>% unique(),
                                                          ColorPre$light_nejm,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_en+
                                   scale_color_gradient2(low = "#5A9F77",high = "#EE4C97")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet/NodePlot_enet_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "jama" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.en$group %>% unique(),
                                                     ColorPre$light_jama,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.en$group %>% unique(),
                                                          ColorPre$light_jama,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_en+
                                   scale_color_gradient2(low = "#79af97",high = "#ff4d00")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet/NodePlot_enet_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               }
                        )
                      },
                      "dark" = {
                        switch(Palette,
                               "cell" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.en$group %>% unique(),
                                                     ColorPre$dark_cell,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.en$group %>% unique(),
                                                          ColorPre$dark_cell,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_en+
                                   scale_color_gradient2(low = "#323695",high = "#A51526")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet/NodePlot_enet_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "nature" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.en$group %>% unique(),
                                                     ColorPre$dark_nature,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.en$group %>% unique(),
                                                          ColorPre$dark_nature,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 Palette = "nature"
                                 NodePlot_en+
                                   scale_color_gradient2(low = "#3C5488",high = "#A51526")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet/NodePlot_enet_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "science" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.en$group %>% unique(),
                                                     ColorPre$dark_science,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.en$group %>% unique(),
                                                          ColorPre$dark_science,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_en+
                                   scale_color_gradient2(low = "#191970",high = "#bb0021")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet/NodePlot_enet_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "lancet" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.en$group %>% unique(),
                                                     ColorPre$dark_lancet,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.en$group %>% unique(),
                                                          ColorPre$dark_lancet,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_en+
                                   scale_color_gradient2(low = "#00468B",high = "#AD002A")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet/NodePlot_enet_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)

                               },
                               "nejm" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.en$group %>% unique(),
                                                     ColorPre$dark_nejm,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.en$group %>% unique(),
                                                          ColorPre$dark_nejm,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_en+
                                   scale_color_gradient2(low = "#6F99AD",high = "#A52A2A")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet/NodePlot_enet_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "jama" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.en$group %>% unique(),
                                                     ColorPre$dark_jama,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.en$group %>% unique(),
                                                          ColorPre$dark_jama,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_en+
                                   scale_color_gradient2(low = "#64acbf",high = "#b24745")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet/NodePlot_enet_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               }
                        )
                      })
               # save the image
               if(Brightness != "all" & Palette != "all"){
                 func_save_net("enet")
               }

             }


             # rf--------------------------------------------------------
             if("rf" %in% SG_Lrns){
               nodes.rf$importance %>% abs() %>% quantile(probs = seq(0,1,0.2)) %>% .[2] -> labThr
               nodes.rf$importance %>% abs() %>% quantile(probs = seq(0,1,0.25)) %>% .[4] -> labThr2
               nodes.rf %<>%
                 mutate(labelsize = case_when(
                   abs(importance) >= labThr ~ 20,
                   abs(importance) < labThr ~ 0),
                   labelsize2 = case_when(
                     abs(importance) >= labThr2 ~ 20,
                     abs(importance) < labThr2 ~ 0))

               nodes.rf %>%
                 ggplot(aes(x=importance,y=MinusLog10P))+
                 geom_point(aes(size=MinusLog10P,shape=group,color=importance))+
                 scale_shape_manual(values = ggNdSp)+
                 scale_size_continuous("-Log10P")+
                 ggrepel::geom_text_repel(data = subset(nodes.rf,
                                                        nodes.rf$labelsize2!=0),
                                          aes(label=id),
                                          box.padding = unit(0.5, "lines"),
                                          point.padding = unit(1, "lines"), segment.color = "grey50",
                                          show.legend = FALSE,max.overlaps = 20)+
                 labs(y="-Log10P")+
                 theme_bw()+
                 theme(panel.grid=element_blank()) -> NodePlot_rf

               RCy3::cytoscapePing()
               closeSession(F)
               RCy3::createNetworkFromDataFrames(nodes.rf,
                                                 edges.rf,
                                                 title = "network-rf",
                                                 collection = "network")
               # set style--------------------------------------------------------
               style = "Style1"
               defaults <- list(NODE_SHAPE="ELLIPS",NODE_SIZE=20,
                                EDGE_TRANSPARENCY=50,EDGE_WIDTH=0.5,NODE_LABEL_POSITION="S,W,c,0.00,0.00")
               nodeLabels <- mapVisualProperty('node label','id','p')
               nodeSize <- mapVisualProperty('Node Size','MinusLog10P',"c",
                                             c(nodes.rf$MinusLog10P %>% min(),
                                               nodes.rf$MinusLog10P %>% median(),
                                               nodes.rf$MinusLog10P %>% max()),
                                             c(5, 10, 20))

               nodeLableFontSize <- mapVisualProperty('Node Label Font Size','labelsize',"p")


               createVisualStyle(style,
                                 defaults,
                                 list(nodeLabels,
                                      nodeSize,
                                      nodeLableFontSize
                                 ))
               setVisualStyle(style)
               switch(Brightness,
                      "light" = {
                        switch(Palette,
                               "cell" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.rf$group %>% unique(),
                                                     ColorPre$light_cell,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.rf$group %>% unique(),
                                                          ColorPre$light_cell,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_rf+
                                   scale_color_gradient2(low = "#64acbf",high = "#ff8033")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/RandomForest/NodePlot_rf_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "nature" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.rf$group %>% unique(),
                                                     ColorPre$light_nature,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.rf$group %>% unique(),
                                                          ColorPre$light_nature,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_rf+
                                   scale_color_gradient2(low = "#4DBBD5",high = "#ff0000")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/RandomForest/NodePlot_rf_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "science" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.rf$group %>% unique(),
                                                     ColorPre$light_science,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.rf$group %>% unique(),
                                                          ColorPre$light_science,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_rf+
                                   scale_color_gradient2(low = "#20B2AA",high = "#EE0000")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/RandomForest/NodePlot_rf_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "lancet" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.rf$group %>% unique(),
                                                     ColorPre$light_lancet,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.rf$group %>% unique(),
                                                          ColorPre$light_lancet,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_rf+
                                   scale_color_gradient2(low = "#0099B4",high = "#ED0000")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/RandomForest/NodePlot_rf_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "nejm" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.rf$group %>% unique(),
                                                     ColorPre$light_nejm,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.rf$group %>% unique(),
                                                          ColorPre$light_nejm,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_rf+
                                   scale_color_gradient2(low = "#5A9F77",high = "#EE4C97")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/RandomForest/NodePlot_rf_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "jama" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.rf$group %>% unique(),
                                                     ColorPre$light_jama,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.rf$group %>% unique(),
                                                          ColorPre$light_jama,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_rf+
                                   scale_color_gradient2(low = "#79af97",high = "#ff4d00")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/RandomForest/NodePlot_rf_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               }
                        )
                      },
                      "dark" = {
                        switch(Palette,
                               "cell" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.rf$group %>% unique(),
                                                     ColorPre$dark_cell,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.rf$group %>% unique(),
                                                          ColorPre$dark_cell,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_rf+
                                   scale_color_gradient2(low = "#323695",high = "#A51526")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/RandomForest/NodePlot_rf_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "nature" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.rf$group %>% unique(),
                                                     ColorPre$dark_nature,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.rf$group %>% unique(),
                                                          ColorPre$dark_nature,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 Palette = "nature"
                                 NodePlot_rf+
                                   scale_color_gradient2(low = "#3C5488",high = "#A51526")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/RandomForest/NodePlot_rf_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "science" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.rf$group %>% unique(),
                                                     ColorPre$dark_science,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.rf$group %>% unique(),
                                                          ColorPre$dark_science,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_rf+
                                   scale_color_gradient2(low = "#191970",high = "#bb0021")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/RandomForest/NodePlot_rf_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "lancet" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.rf$group %>% unique(),
                                                     ColorPre$dark_lancet,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.rf$group %>% unique(),
                                                          ColorPre$dark_lancet,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)

                                 NodePlot_rf+
                                   scale_color_gradient2(low = "#00468B",high = "#AD002A")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/RandomForest/NodePlot_rf_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)

                               },
                               "nejm" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.rf$group %>% unique(),
                                                     ColorPre$dark_nejm,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.rf$group %>% unique(),
                                                          ColorPre$dark_nejm,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)

                                 NodePlot_rf+
                                   scale_color_gradient2(low = "#6F99AD",high = "#A52A2A")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/RandomForest/NodePlot_rf_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "jama" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.rf$group %>% unique(),
                                                     ColorPre$dark_jama,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.rf$group %>% unique(),
                                                          ColorPre$dark_jama,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)

                                 NodePlot_rf+
                                   scale_color_gradient2(low = "#64acbf",high = "#b24745")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/RandomForest/NodePlot_rf_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               }
                        )
                      })
               # save the image
               if(Brightness != "all" & Palette != "all"){
                 func_save_net("rf")
               }




             }


             # xgb--------------------------------------------------------
             if("xgboost" %in% SG_Lrns){
               nodes.xgb$importance %>% abs() %>% quantile(probs = seq(0,1,0.2)) %>% .[2] -> labThr
               nodes.xgb$importance %>% abs() %>% quantile(probs = seq(0,1,0.25)) %>% .[4] -> labThr2
               nodes.xgb %<>%
                 mutate(labelsize = case_when(
                   abs(importance) >= labThr ~ 20,
                   abs(importance) < labThr ~ 0),
                   labelsize2 = case_when(
                     abs(importance) >= labThr2 ~ 20,
                     abs(importance) < labThr2 ~ 0))

               nodes.xgb %>%
                 ggplot(aes(x=importance,y=MinusLog10P))+
                 geom_point(aes(size=MinusLog10P,shape=group,color=importance))+
                 scale_shape_manual(values = ggNdSp)+
                 scale_size_continuous("-Log10P")+
                 ggrepel::geom_text_repel(data = subset(nodes.xgb,
                                                        nodes.xgb$labelsize2!=0),
                                          aes(label=id),
                                          box.padding = unit(0.5, "lines"),
                                          point.padding = unit(1, "lines"), segment.color = "grey50",
                                          show.legend = FALSE,max.overlaps = 20)+
                 labs(y="-Log10P")+
                 theme_bw()+
                 theme(panel.grid=element_blank()) -> NodePlot_xgb

               RCy3::cytoscapePing()
               closeSession(F)
               RCy3::createNetworkFromDataFrames(nodes.xgb,
                                                 edges.xgb,
                                                 title = "network-xgboost",
                                                 collection = "network")
               # set style--------------------------------------------------------
               style = "Style1"
               defaults <- list(NODE_SHAPE="ELLIPS",NODE_SIZE=20,
                                EDGE_TRANSPARENCY=50,EDGE_WIDTH=0.5,NODE_LABEL_POSITION="S,W,c,0.00,0.00")
               nodeLabels <- mapVisualProperty('node label','id','p')
               nodeSize <- mapVisualProperty('Node Size','MinusLog10P',"c",
                                             c(nodes.xgb$MinusLog10P %>% min(),
                                               nodes.xgb$MinusLog10P %>% median(),
                                               nodes.xgb$MinusLog10P %>% max()),
                                             c(5, 10, 20))

               nodeLableFontSize <- mapVisualProperty('Node Label Font Size','labelsize',"p")


               createVisualStyle(style,
                                 defaults,
                                 list(nodeLabels,
                                      nodeSize,
                                      nodeLableFontSize
                                 ))
               setVisualStyle(style)
               switch(Brightness,
                      "light" = {
                        switch(Palette,
                               "cell" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.xgb$group %>% unique(),
                                                     ColorPre$light_cell,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.xgb$group %>% unique(),
                                                          ColorPre$light_cell,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_xgb+
                                   scale_color_gradient2(low = "#64acbf",high = "#ff8033")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Xgboost/NodePlot_xgboost_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "nature" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.xgb$group %>% unique(),
                                                     ColorPre$light_nature,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.xgb$group %>% unique(),
                                                          ColorPre$light_nature,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_xgb+
                                   scale_color_gradient2(low = "#4DBBD5",high = "#ff0000")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Xgboost/NodePlot_xgboost_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "science" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.xgb$group %>% unique(),
                                                     ColorPre$light_science,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.xgb$group %>% unique(),
                                                          ColorPre$light_science,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_xgb+
                                   scale_color_gradient2(low = "#20B2AA",high = "#EE0000")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Xgboost/NodePlot_xgboost_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "lancet" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.xgb$group %>% unique(),
                                                     ColorPre$light_lancet,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.xgb$group %>% unique(),
                                                          ColorPre$light_lancet,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_xgb+
                                   scale_color_gradient2(low = "#0099B4",high = "#ED0000")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Xgboost/NodePlot_xgboost_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "nejm" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.xgb$group %>% unique(),
                                                     ColorPre$light_nejm,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.xgb$group %>% unique(),
                                                          ColorPre$light_nejm,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_xgb+
                                   scale_color_gradient2(low = "#5A9F77",high = "#EE4C97")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Xgboost/NodePlot_xgboost_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "jama" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.xgb$group %>% unique(),
                                                     ColorPre$light_jama,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.xgb$group %>% unique(),
                                                          ColorPre$light_jama,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_xgb+
                                   scale_color_gradient2(low = "#79af97",high = "#ff4d00")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Xgboost/NodePlot_xgboost_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               }
                        )
                      },
                      "dark" = {
                        switch(Palette,
                               "cell" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.xgb$group %>% unique(),
                                                     ColorPre$dark_cell,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.xgb$group %>% unique(),
                                                          ColorPre$dark_cell,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_xgb+
                                   scale_color_gradient2(low = "#323695",high = "#A51526")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Xgboost/NodePlot_xgboost_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "nature" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.xgb$group %>% unique(),
                                                     ColorPre$dark_nature,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.xgb$group %>% unique(),
                                                          ColorPre$dark_nature,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 Palette = "nature"
                                 NodePlot_xgb+
                                   scale_color_gradient2(low = "#3C5488",high = "#A51526")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Xgboost/NodePlot_xgboost_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "science" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.xgb$group %>% unique(),
                                                     ColorPre$dark_science,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.xgb$group %>% unique(),
                                                          ColorPre$dark_science,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_xgb+
                                   scale_color_gradient2(low = "#191970",high = "#bb0021")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Xgboost/NodePlot_xgboost_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "lancet" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.xgb$group %>% unique(),
                                                     ColorPre$dark_lancet,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.xgb$group %>% unique(),
                                                          ColorPre$dark_lancet,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_xgb+
                                   scale_color_gradient2(low = "#00468B",high = "#AD002A")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Xgboost/NodePlot_xgboost_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)

                               },
                               "nejm" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.xgb$group %>% unique(),
                                                     ColorPre$dark_nejm,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.xgb$group %>% unique(),
                                                          ColorPre$dark_nejm,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_xgb+
                                   scale_color_gradient2(low = "#6F99AD",high = "#A52A2A")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Xgboost/NodePlot_xgboost_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               },
                               "jama" = {
                                 setNodeColorMapping(mapping.type = 'd',
                                                     table.column = 'group',
                                                     table.column.values = nodes.xgb$group %>% unique(),
                                                     ColorPre$dark_jama,
                                                     style.name = style)
                                 setNodeLabelColorMapping(mapping.type = 'd',
                                                          table.column = 'group',
                                                          table.column.values = nodes.xgb$group %>% unique(),
                                                          ColorPre$dark_jama,
                                                          style.name = style)
                                 setNodeBorderWidthDefault(new.width = 0,style.name = style)
                                 NodePlot_xgb+
                                   scale_color_gradient2(low = "#64acbf",high = "#b24745")
                                 ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Xgboost/NodePlot_xgboost_",
                                                         Brightness,"_",Palette,"_", NowTime,".png"),height = 6,width = 8)
                               }
                        )
                      })
               # save the image
               if(Brightness != "all" & Palette != "all"){
                 func_save_net("xgboost")
               }

             }
           }
           VizAllNet(eSet,
                     VarsY = VarsY,
                     Layout = Layout,
                     Brightness = Brightness,
                     Palette = Palette)
         },
         'ggraph' = {
           eSet$MulOmics$OmicGroup.all -> OmicGroups
           # Viz Intraomic Networks------------
           # lubridate::now() %>%
           #   stringr::str_replace_all(":",".") %>%
           #   stringr::str_replace_all("-",".") -> NowTime
           # message(stringr::str_c("Visualizing Intraomic Networks...",NowTime))
           # eSet$ExcecutionLog  <- eSet$AddLog(stringr::str_c("Visualizing Intraomic Networks...",NowTime))
           # source("functions/VizOmicNetGgraph.R")
           # map(OmicGroups,
           #     VizOmicNetGgraph,
           #     eSet = eSet,
           #     Layout = Layout,
           #     Brightness = Brightness,
           #     Palette = Palette)
           # Viz All Networks-----------------
           lubridate::now() %>%
             stringr::str_replace_all(":",".") %>%
             stringr::str_replace_all("-",".") -> NowTime
           message(stringr::str_c("Visualizing Interomic Networks...",NowTime))
           eSet$ExcecutionLog  <- eSet$AddLog(stringr::str_c("Visualizing Interomic Networks...",NowTime))

           VizAllNetGgraph <- function(eSet,
                                       Layout,
                                       Brightness,
                                       Palette){
             lubridate::now() %>%
               stringr::str_replace_all(":",".") %>%
               stringr::str_replace_all("-",".") -> NowTime

             Path = stringr::str_c(eSet$FileDirOut)
             if(!file.exists(Path)) {dir.create(Path)}

             SG_Lrns <- eSet$MulOmics$Max_NodeNum$Learners

             # color -------------------------------------------------------------------
             ColorPre <- NULL
             # bright
             c("#FBD266","#8FB0A9","#D76735","#2FA3DC","#F9776A","#F2D8B3","#00b283","#df408a") -> ColorPre[["light_cell"]]
             c("#f39b7f","#4DBBD5","#E64B35","#495e8F","#00A087","#FB3C04","#FF9646","#69CCBB") -> ColorPre[["light_nature"]]
             c("#B85798","#20B2AA","#EE0000","#ffb367","#F06B49","#60C9FF","#F5B2AC","#ECC2F1") -> ColorPre[["light_science"]]
             c("#FFB366","#0099B4","#ED0000","#925E9F","#42b540","#fdaf91","#0297d9","#ff6347") -> ColorPre[["light_lancet"]]
             c("#E18727","#4A91C5","#EE4C97","#8ED14B","#F5B2AC","#F06B49","#ECC2F1","#82C7C3") -> ColorPre[["light_nejm"]]
             c("#79af97","#00A1D5","#FF4D00","#FFA54F","#66CDAA","#9370DB","#DC143C","#E6B800") -> ColorPre[["light_jama"]]
             RColorBrewer::brewer.pal(8,"Set2") -> ColorPre[["light_default1"]]
             RColorBrewer::brewer.pal(8,"Set3") -> ColorPre[["light_default2"]]
             # dark
             c("#8B7366","#2F375B","#A23419","#be9619","#8e0f00","#13506d","#874338", "#EFD78D") -> ColorPre[["dark_cell"]]
             c("#8B7500","#3C5488","#A51526","#8491B4","#CD3D32","#00A087","#e69966","#7ab8cc") -> ColorPre[["dark_nature"]]
             c("#631879","#3B4992","#A20056","#CD6601","#89363A","#076B82","#bb0021","#1B9F2E") -> ColorPre[["dark_science"]]
             c("#925E9F","#00468B","#AD002A","#db6024","#ADB6B6", "#00808c","#800080","#16982b") -> ColorPre[["dark_lancet"]]
             c("#6F99AD","#533085","#A52A2A","#2A52BE","#cc7722","#1E003C","#076B82","#1B9F2E") -> ColorPre[["dark_nejm"]]
             c("#6A6599","#374e55","#b24745","#02567A","#DF8F44","#cc5500","#8fbc8f","#80796b") -> ColorPre[["dark_jama"]]
             RColorBrewer::brewer.pal(8,"Dark2") -> ColorPre[["dark_default1"]]
             c("#ce1554","#FBC02D","#ff753c","#2d755e","#355C7D","#F67280","#7B1FA2","#D49A89") -> ColorPre[["dark_default2"]]

             # Set edges and nodes----------
             if("lasso" %in% SG_Lrns){
               eSet$MulOmics$NetWork$Stat$lasso$edge -> edges.ls
               eSet$MulOmics$NetWork$Stat$lasso$node -> nodes.ls

               nodes.ls %>%
                 dplyr::filter(stringr::str_detect(id,"E")) %>%
                 dplyr::distinct(id,.keep_all = TRUE) -> nodes.ls

               edges.ls %>%
                 dplyr::filter(stringr::str_detect(source,'E')) %>%
                 dplyr::filter(stringr::str_detect(target,'E')) -> edges.ls

               if(!file.exists(str_c(Path,"/2_SG/Viz_InterOmic/Lasso"))){
                 dir.create(str_c(Path,"/2_SG/Viz_InterOmic/Lasso"))}
             }

             if("enet" %in% SG_Lrns){
               eSet$MulOmics$NetWork$Stat$enet$edge -> edges.en
               eSet$MulOmics$NetWork$Stat$enet$node -> nodes.en

               nodes.en %>%
                 dplyr::filter(stringr::str_detect(id,"E")) %>%
                 dplyr::distinct(id,.keep_all = TRUE) -> nodes.en

               edges.en %>%
                 dplyr::filter(stringr::str_detect(source,'E')) %>%
                 dplyr::filter(stringr::str_detect(target,'E')) -> edges.en

               if(!file.exists(str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet"))){
                 dir.create(str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet"))}
             }

             if("rf" %in% SG_Lrns){
               eSet$MulOmics$NetWork$Stat$rf$edge -> edges.rf
               eSet$MulOmics$NetWork$Stat$rf$node -> nodes.rf

               nodes.rf %>%
                 dplyr::filter(stringr::str_detect(id,"E")) %>%
                 dplyr::distinct(id,.keep_all = TRUE) -> nodes.rf

               edges.rf %>%
                 dplyr::filter(stringr::str_detect(source,'E')) %>%
                 dplyr::filter(stringr::str_detect(target,'E')) -> edges.rf

               if(!file.exists(str_c(Path,"/2_SG/Viz_InterOmic/RandomForest"))){
                 dir.create(str_c(Path,"/2_SG/Viz_InterOmic/RandomForest"))}
             }

             if("xgboost" %in% SG_Lrns){
               eSet$MulOmics$NetWork$Stat$xgboost$edge -> edges.xgb
               eSet$MulOmics$NetWork$Stat$xgboost$node -> nodes.xgb

               nodes.xgb %>%
                 dplyr::filter(stringr::str_detect(id,"E")) %>%
                 dplyr::distinct(id,.keep_all = TRUE) -> nodes.xgb

               edges.xgb %>%
                 dplyr::filter(stringr::str_detect(source,'E')) %>%
                 dplyr::filter(stringr::str_detect(target,'E')) -> edges.xgb

               if(!file.exists(str_c(Path,"/2_SG/Viz_InterOmic/Xgboost"))){
                 dir.create(str_c(Path,"/2_SG/Viz_InterOmic/Xgboost"))}
             }



             # shape and color ---------------------------------------------------------
             ggNdSp <- c(18,16,17,15,25,10,7,8)
             mycolor <- NULL
             c("#64acbf","#1b6393","#ff8033") -> mycolor[['light_cell']]
             c("#4DBBD5","#5c50e6","#ff0000") -> mycolor[['light_nature']]
             c("#20B2AA","#5000B8","#EE0000") -> mycolor[['light_science']]
             c("#0099B4","#ffb366","#ED0000") -> mycolor[['light_lancet']]
             c("#5A9F77","#E18727","#EE4C97") -> mycolor[['light_nejm']]
             c("#79af97","#FFA54F","#ff4d00") -> mycolor[['light_jama']]
             c("#98BFFA","#f9a255","#F6416C") -> mycolor[['light_default1']]
             c("#45D9A6","#E2FFBE","#C389FA") -> mycolor[['light_default2']]

             c("#323695","#698B69","#A51526") -> mycolor[['dark_cell']]
             c("#3C5488","#8B7500","#A51526") -> mycolor[['dark_nature']]
             c("#191970","#008280","#bb0021") -> mycolor[['dark_science']]
             c("#00468B","#ADB6B6","#AD002A") -> mycolor[['dark_lancet']]
             c("#6F99AD","#CC5500","#A52A2A") -> mycolor[['dark_nejm']]
             c("#64acbf","#374e55","#b24745") -> mycolor[['dark_jama']]
             c("#C9B928","#6867AC","#461736") -> mycolor[['dark_default1']]
             c("#355C7D","#D49A89","#F67280") -> mycolor[['dark_default2']]


             # ls--------------------------------------------------------
             if("lasso" %in% SG_Lrns){
               nodes.ls$Coef %>% abs() %>% quantile(probs = seq(0,1,0.2)) %>% .[2] -> labThr
               nodes.ls$Coef %>% abs() %>% quantile(probs = seq(0,1,0.25)) %>% .[4] -> labThr2
               nodes.ls %<>%
                 mutate(labelsize = case_when(abs(Coef) >= labThr ~ 20,
                                              abs(Coef) < labThr ~ 0),
                        labelsize2 = case_when(abs(Coef) >= labThr2 ~ 20,
                                               abs(Coef) < labThr2 ~ 0),
                        absCoef = abs(Coef))

               # node plot ---------------------------------------------------------------
               nodes.ls %>%
                 ggplot2::ggplot(aes(x=Coef,y=MinusLog10P))+
                 ggplot2::geom_point(aes(size=MinusLog10P,shape=group,color=Coef))+
                 ggplot2::scale_shape_manual(values = ggNdSp)+
                 ggplot2::scale_y_continuous(limits = c(0,max(nodes.ls$MinusLog10P)))+
                 ggplot2::geom_vline(xintercept = 0,
                                     color = "grey",
                                     size = 0.1)+
                 ggplot2::geom_hline(yintercept = -log10(0.05),
                                     color = "grey",
                                     size = 0.1)+
                 ggplot2::scale_size_continuous("-Log10P")+
                 ggplot2::scale_color_gradient2(low = mycolor[[stringr::str_c(Brightness,"_",Palette)]][1],
                                                high = mycolor[[stringr::str_c(Brightness,"_",Palette)]][3])+
                 ggrepel::geom_text_repel(data = subset(nodes.ls,
                                                        nodes.ls$labelsize2!=0),
                                          aes(label=id),
                                          box.padding = unit(0.5, "lines"),
                                          point.padding = unit(1, "lines"), segment.color = "grey50",
                                          show.legend = FALSE,max.overlaps = 20)+
                 ggplot2::labs(y="-Log10P")+
                 ggplot2::theme_bw()+
                 ggplot2::theme(panel.grid=element_blank()) -> NodePlot_ls

               eSet$MulOmics$NetWork$NodePlot[["lasso"]] <- gridExtra::marrangeGrob(list(NodePlot_ls),
                                                                                    nrow = 1,ncol = 1,
                                                                                    top = title)

               # save node plot ----------------------------------------------------------
               ggplot2::ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Lasso/NodePlot_lasso_",
                                                Brightness,"_",Palette,".png"),
                               plot = eSet$MulOmics$NetWork$NodePlot[["lasso"]],
                               height = 6,
                               width = 8)

               ggplot2::ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Lasso/NodePlot_lasso_",
                                                Brightness,"_",Palette,".svg"),
                               plot = eSet$MulOmics$NetWork$NodePlot[["lasso"]],
                               height = 6,
                               width = 8)

               # network plot ------------------------------------------------------------
               # delect duplicate edges --------------------------------------------------
               edges.ls %>%
                 dplyr::mutate(sourcename = str_remove(source,"E")) %>%
                 dplyr::mutate(targetname = str_remove(target,"E")) %>%
                 dplyr::mutate(sourcename = as.numeric(sourcename)) %>%
                 dplyr::mutate(targetname = as.numeric(targetname)) -> edges.ls

               func_CheckDuplicate <- function(x){
                 edges.ls %>%
                   dplyr::slice(x) %>%
                   dplyr::mutate(check1 = max(c(sourcename,targetname))) %>%
                   dplyr::mutate(check2 = min(c(sourcename,targetname)))-> rowuq
               }

               purrr::map_dfr(1:nrow(edges.ls),func_CheckDuplicate) %>%
                 dplyr::mutate(check = str_c(check1,"-",check2)) %>%
                 dplyr::distinct(check,.keep_all = TRUE) %>%
                 dplyr::select(-c(sourcename,targetname,check1,check2,check))-> edges.ls

               # prepare data ------------------------------------------------------------
               edges.ls %>%
                 dplyr::select(source,target,R) %>%
                 setNames(c("from","to","value")) -> connect_data

               nodes.ls$group %>% unique() -> OmicGroup

               rbind(
                 data.frame(from = "origin",
                            to = OmicGroup),
                 data.frame(to = unique(c(as.character(connect_data$to),as.character(connect_data$to)))) %>%
                   dplyr::left_join(nodes.ls %>%
                                      dplyr::select(id,group),
                                    by = c("to" = "id")) %>%
                   dplyr::arrange(group) %>%
                   setNames(c("to","from")) %>%
                   dplyr::select(from,to)
               ) -> Edges

               data.frame(
                 name = unique(c(as.character(Edges$from),as.character(Edges$to)))
               ) -> vertices_data

               vertices_data %<>%
                 dplyr::left_join(nodes.ls %>%
                                    dplyr::select(id,MinusLog10P,group),
                                  by = c("name" = "id")) %>%
                 dplyr::mutate(MinusLog10P = stringr::str_replace_na(MinusLog10P,replacement = "1")) %>%
                 setNames(c("name","value","groupname")) %>%
                 dplyr::mutate(value = as.numeric(value)) %>%
                 setNames(c("name","MinusLog10P","groupname"))

               vertices_data %<>%
                 dplyr::mutate(Group = Edges$from[ match( vertices_data$name, Edges$to ) ],
                               id = NA)
               Leaves <- which(is.na(match(vertices_data$name,Edges$from)))
               NLeaves <- length(Leaves)
               vertices_data$id[Leaves] <- seq(1:NLeaves)
               vertices_data$angle <- 90 - 360 * vertices_data$id / NLeaves
               vertices_data$hjust <- ifelse(vertices_data$angle < -90,1,0)
               vertices_data$angle <- ifelse(vertices_data$angle < -90,vertices_data$angle+180,
                                             vertices_data$angle)

               c(as.character(connect_data$from),as.character(connect_data$to)) %>%
                 as_tibble() %>%
                 dplyr::group_by(value) %>%
                 dplyr::summarize(n=n()) %>%
                 # dplyr::left_join(eSet$Expo$Voca %>%
                 #                    dplyr::select(SerialNo_Raw,
                 #                                  GroupName),by = c("value" = "SerialNo_Raw")) %>%
                 dplyr::left_join(nodes.ls %>%
                                    dplyr::select(id,label,group,MinusLog10P),
                                  by = c("value" = "id")) -> Vertices

               colnames(Vertices) <- c("name", "n","label","groupname","MinusLog10P")

               mygraph <- igraph::graph_from_data_frame( connect_data, vertices = Vertices, directed = FALSE )

               com <- igraph::walktrap.community(mygraph)

               Vertices1 <- Vertices %>%
                 dplyr::mutate( group = com$membership) %>%
                 dplyr::mutate(group=as.numeric(factor(group,
                                                       levels=sort(summary (as.factor(group)),index.return=TRUE,decreasing = T)$ix,
                                                       order=TRUE)))%>%
                 dplyr::filter( group<10) %>%
                 dplyr::arrange(group,desc(n)) %>%
                 dplyr::mutate(name=factor(name, name))

               Connect_data <- connect_data %>%
                 dplyr::filter(from %in% Vertices1$name) %>%
                 dplyr::filter(to %in% Vertices1$name) %>%
                 dplyr::left_join(Vertices1,by=c('from'='name'))


               mygraph <- igraph::graph_from_data_frame( Connect_data, vertices = Vertices1, directed = FALSE )
               #mycolor <- wesanderson::wes_palette("Darjeeling1", max(Vertices1$group), type = "continuous")

               # labelsize ---------------------------------------------------------------
               if(nrow(nodes.ls) <= 100){
                 LabelSize = 3
               }else if(nrow(nodes.ls) > 100 & nrow(nodes.ls) <= 300){
                 LabelSize = 2.5
               }else if(nrow(nodes.ls) >300 & nrow(nodes.ls) <= 450){
                 LabelSize = 2
               }else if(nrow(nodes.ls) >450 & nrow(nodes.ls) <= 600){
                 LabelSize = 1.5
               }else{
                 LabelSize = 1
               }
               # Plot --------------------------------------------------------------------
               switch(Layout,
                      "force-directed" = {
                        set.seed(123)
                        ddpcr::quiet(
                          ggraph::ggraph(mygraph,layout='fr') +
                            ggraph::geom_edge_link(edge_colour="grey50", edge_alpha=0.2, edge_width=0.3) +
                            ggraph::geom_node_point(ggplot2::aes(size=MinusLog10P, fill=groupname), shape=21,color='grey20',alpha=0.9) +
                            ggplot2::scale_size_continuous(range=c(0.5,10)) +
                            ggraph::geom_node_text(ggplot2::aes(label = label),
                                                   nudge_x = 0.12,
                                                   nudge_y = -0.12,
                                                   size=LabelSize,
                                                   color="grey30") +
                            ggplot2::scale_fill_manual(values = ColorPre[[stringr::str_c(Brightness,"_",Palette)]][1:length(nodes.ls$group %>% unique())])+
                            ggplot2::expand_limits(x = c(-1.2, 1.2), y = c(-1.2, 1.2))+
                            ggplot2::theme_bw() +
                            ggplot2::labs(size = "MinusLog10P",
                                          fill = "Group")+
                            ggplot2::theme(panel.grid = element_blank(),
                                           axis.line = element_blank(),
                                           axis.ticks =element_blank(),
                                           axis.text =element_blank(),
                                           axis.title = element_blank()) -> networkPlot
                        )
                      },
                      "degree-circle" = {
                        #构造数据标签的放置角度
                        number_of_bar<-nrow(Vertices1)
                        Vertices1$id<-seq(1, nrow(Vertices1))
                        angle<- 360 * (Vertices1$id-0.5) /number_of_bar
                        Vertices1$hjust<-ifelse(angle>180, 1, 0)
                        Vertices1$angle<-ifelse(angle>180, 90-angle+180, 90-angle)
                        mygraph <- igraph::graph_from_data_frame( Connect_data, vertices = Vertices1, directed = FALSE )
                        # 重新构造 graph 图结构的数据
                        ggraph(mygraph,layout = 'linear', circular = TRUE) +
                          ggraph::geom_edge_arc(aes(edge_colour=groupname), edge_alpha=1, edge_width=0.5,
                                                show.legend = FALSE) +
                          ggraph::geom_node_point(aes(size=MinusLog10P, fill=groupname), shape=21,
                                                  #alpha=0.9,
                                                  color='grey20') +
                          ggplot2::scale_size_continuous(range=c(0.5,10)) +
                          ggplot2::scale_fill_manual(values = ColorPre[[stringr::str_c(Brightness,"_",Palette)]][1:length(nodes.ls$group %>% unique())])+
                          ggraph::geom_node_text(aes(x = x*1.09, y=y*1.09, label=label, angle=angle,hjust=hjust),
                                                 size=LabelSize,
                                                 show.legend = FALSE,
                                                 color='grey30') +
                          ggraph::scale_edge_color_manual(values = ColorPre[[stringr::str_c(Brightness,"_",Palette)]][1:length(nodes.ls$group %>% unique())])+
                          ggplot2::labs(size = "MinusLog10P",
                                        fill = "Group")+
                          ggplot2::expand_limits(x = c(-1.6, 1.6), y = c(-1.6, 1.6))+
                          ggplot2::coord_fixed()+
                          ggplot2::theme_bw()+
                          ggplot2::theme(panel.grid = element_blank(),
                                         panel.border = element_blank(),
                                         axis.line = element_blank(),
                                         axis.ticks =element_blank(),
                                         axis.text =element_blank(),
                                         axis.title = element_blank()) -> networkPlot
                      }
               )

               eSet$MulOmics$NetWork$networkplot[["lasso"]] <- gridExtra::marrangeGrob(list(networkPlot),
                                                                                       nrow = 1,ncol = 1,
                                                                                       top = title)
               # save --------------------------------------------------------------------
               ggplot2::ggsave(stringr::str_c(Path,"/2_SG/Viz_InterOmic/Lasso/NetworkPlot_lasso_",
                                              Layout,"_",Brightness,"_",Palette,".png"),
                               plot = eSet$MulOmics$NetWork$networkplot[["lasso"]],
                               width =  20,
                               height = 20,
                               units = "cm")

               ggplot2::ggsave(stringr::str_c(Path,"/2_SG/Viz_InterOmic/Lasso/NetworkPlot_lasso_",
                                              Layout,"_",Brightness,"_",Palette,".svg"),
                               plot = eSet$MulOmics$NetWork$networkplot[["lasso"]],
                               width =  20,
                               height = 20,
                               units = "cm")

             }

             # en--------------------------------------------------------
             if("enet" %in% SG_Lrns){
               nodes.en$Coef %>% abs() %>% quantile(probs = seq(0,1,0.2)) %>% .[2] -> labThr
               nodes.en$Coef %>% abs() %>% quantile(probs = seq(0,1,0.25)) %>% .[4] -> labThr2
               nodes.en %<>%
                 mutate(labelsize = case_when(abs(Coef) >= labThr ~ 20,
                                              abs(Coef) < labThr ~ 0),
                        labelsize2 = case_when(abs(Coef) >= labThr2 ~ 20,
                                               abs(Coef) < labThr2 ~ 0),
                        absCoef = abs(Coef))
               # node plot ---------------------------------------------------------------
               nodes.en %>%
                 ggplot2::ggplot(aes(x=Coef,y=MinusLog10P))+
                 ggplot2::geom_point(aes(size=MinusLog10P,shape=group,color=Coef))+
                 ggplot2::scale_shape_manual(values = ggNdSp)+
                 ggplot2::scale_y_continuous(limits = c(0,max(nodes.en$MinusLog10P)))+
                 ggplot2::geom_vline(xintercept = 0,
                                     color = "grey",
                                     size = 0.1)+
                 ggplot2::geom_hline(yintercept = -log10(0.05),
                                     color = "grey",
                                     size = 0.1)+
                 ggplot2::scale_size_continuous("-Log10P")+
                 ggplot2::scale_color_gradient2(low = mycolor[[stringr::str_c(Brightness,"_",Palette)]][1],
                                                high = mycolor[[stringr::str_c(Brightness,"_",Palette)]][3])+
                 ggrepel::geom_text_repel(data = subset(nodes.en,
                                                        nodes.en$labelsize2!=0),
                                          aes(label=id),
                                          box.padding = unit(0.5, "lines"),
                                          point.padding = unit(1, "lines"), segment.color = "grey50",
                                          show.legend = FALSE,max.overlaps = 20)+
                 ggplot2::labs(y="-Log10P")+
                 ggplot2::theme_bw()+
                 ggplot2::theme(panel.grid=element_blank()) -> NodePlot_en

               eSet$MulOmics$NetWork$NodePlot[["EN"]] <- gridExtra::marrangeGrob(list(NodePlot_en),
                                                                                 nrow = 1,ncol = 1,
                                                                                 top = title)

               # save node plot ----------------------------------------------------------
               ggplot2::ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet/NodePlot_enet_",
                                                Brightness,"_",Palette,".png"),
                               plot = eSet$MulOmics$NetWork$NodePlot[["EN"]],
                               height = 6,
                               width = 8)

               ggplot2::ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet/NodePlot_enet_",
                                                Brightness,"_",Palette,".svg"),
                               plot = eSet$MulOmics$NetWork$NodePlot[["EN"]],
                               height = 6,
                               width = 8)

               # network plot ------------------------------------------------------------
               # delect duplicate edges --------------------------------------------------
               edges.en %>%
                 dplyr::mutate(sourcename = str_remove(source,"E")) %>%
                 dplyr::mutate(targetname = str_remove(target,"E")) %>%
                 dplyr::mutate(sourcename = as.numeric(sourcename)) %>%
                 dplyr::mutate(targetname = as.numeric(targetname)) -> edges.en

               func_CheckDuplicate <- function(x){
                 edges.en %>%
                   dplyr::slice(x) %>%
                   dplyr::mutate(check1 = max(c(sourcename,targetname))) %>%
                   dplyr::mutate(check2 = min(c(sourcename,targetname)))-> rowuq
               }

               purrr::map_dfr(1:nrow(edges.en),func_CheckDuplicate) %>%
                 dplyr::mutate(check = str_c(check1,"-",check2)) %>%
                 dplyr::distinct(check,.keep_all = TRUE) %>%
                 dplyr::select(-c(sourcename,targetname,check1,check2,check))-> edges.en

               # prepare data ------------------------------------------------------------
               edges.en %>%
                 dplyr::select(source,target,R) %>%
                 setNames(c("from","to","value")) -> connect_data

               nodes.en$group %>% unique() -> OmicGroup

               rbind(
                 data.frame(from = "origin",
                            to = OmicGroup),
                 data.frame(to = unique(c(as.character(connect_data$to),as.character(connect_data$to)))) %>%
                   dplyr::left_join(nodes.en %>%
                                      dplyr::select(id,group),
                                    by = c("to" = "id")) %>%
                   dplyr::arrange(group) %>%
                   setNames(c("to","from")) %>%
                   dplyr::select(from,to)
               ) -> Edges

               data.frame(
                 name = unique(c(as.character(Edges$from),as.character(Edges$to)))
               ) -> vertices_data

               vertices_data %<>%
                 dplyr::left_join(nodes.en %>%
                                    dplyr::select(id,MinusLog10P,group),
                                  by = c("name" = "id")) %>%
                 dplyr::mutate(MinusLog10P = stringr::str_replace_na(MinusLog10P,replacement = "1")) %>%
                 setNames(c("name","value","groupname")) %>%
                 dplyr::mutate(value = as.numeric(value)) %>%
                 setNames(c("name","MinusLog10P","groupname"))

               vertices_data %<>%
                 dplyr::mutate(Group = Edges$from[ match( vertices_data$name, Edges$to ) ],
                               id = NA)
               Leaves <- which(is.na(match(vertices_data$name,Edges$from)))
               NLeaves <- length(Leaves)
               vertices_data$id[Leaves] <- seq(1:NLeaves)
               vertices_data$angle <- 90 - 360 * vertices_data$id / NLeaves
               vertices_data$hjust <- ifelse(vertices_data$angle < -90,1,0)
               vertices_data$angle <- ifelse(vertices_data$angle < -90,vertices_data$angle+180,
                                             vertices_data$angle)

               c(as.character(connect_data$from),as.character(connect_data$to)) %>%
                 as_tibble() %>%
                 dplyr::group_by(value) %>%
                 dplyr::summarize(n=n()) %>%
                 # dplyr::left_join(eSet$Expo$Voca %>%
                 #                    dplyr::select(SerialNo_Raw,
                 #                                  GroupName),by = c("value" = "SerialNo_Raw")) %>%
                 dplyr::left_join(nodes.en %>%
                                    dplyr::select(id,label,group,MinusLog10P),
                                  by = c("value" = "id")) -> Vertices

               colnames(Vertices) <- c("name", "n","label","groupname","MinusLog10P")

               mygraph <- igraph::graph_from_data_frame( connect_data, vertices = Vertices, directed = FALSE )

               com <- igraph::walktrap.community(mygraph)

               Vertices1 <- Vertices %>%
                 dplyr::mutate( group = com$membership) %>%
                 dplyr::mutate(group=as.numeric(factor(group,
                                                       levels=sort(summary (as.factor(group)),index.return=TRUE,decreasing = T)$ix,
                                                       order=TRUE)))%>%
                 dplyr::filter( group<10) %>%
                 dplyr::arrange(group,desc(n)) %>%
                 dplyr::mutate(name=factor(name, name))

               Connect_data <- connect_data %>%
                 dplyr::filter(from %in% Vertices1$name) %>%
                 dplyr::filter(to %in% Vertices1$name) %>%
                 dplyr::left_join(Vertices1,by=c('from'='name'))


               mygraph <- igraph::graph_from_data_frame( Connect_data, vertices = Vertices1, directed = FALSE )
               #mycolor <- wesanderson::wes_palette("Darjeeling1", max(Vertices1$group), type = "continuous")

               # labelsize ---------------------------------------------------------------
               if(nrow(nodes.en) <= 100){
                 LabelSize = 3
               }else if(nrow(nodes.en) > 100 & nrow(nodes.en) <= 300){
                 LabelSize = 2.5
               }else if(nrow(nodes.en) >300 & nrow(nodes.en) <= 450){
                 LabelSize = 2
               }else if(nrow(nodes.en) >450 & nrow(nodes.en) <= 600){
                 LabelSize = 1.5
               }else{
                 LabelSize = 1
               }
               # Plot --------------------------------------------------------------------
               switch(Layout,
                      "force-directed" = {
                        set.seed(123)
                        ddpcr::quiet(
                          ggraph::ggraph(mygraph,layout='fr') +
                            ggraph::geom_edge_link(edge_colour="grey50", edge_alpha=0.2, edge_width=0.3) +
                            ggraph::geom_node_point(ggplot2::aes(size=MinusLog10P, fill=groupname), shape=21,color='grey20',alpha=0.9) +
                            ggplot2::scale_size_continuous(range=c(0.5,10)) +
                            ggraph::geom_node_text(ggplot2::aes(label = label),
                                                   nudge_x = 0.12,
                                                   nudge_y = -0.12,
                                                   size=LabelSize,
                                                   color="grey30") +
                            ggplot2::scale_fill_manual(values = ColorPre[[stringr::str_c(Brightness,"_",Palette)]][1:length(nodes.en$group %>% unique())])+
                            ggplot2::expand_limits(x = c(-1.2, 1.2), y = c(-1.2, 1.2))+
                            ggplot2::theme_bw() +
                            ggplot2::labs(size = "MinusLog10P",
                                          fill = "Group")+
                            ggplot2::theme(panel.grid = element_blank(),
                                           axis.line = element_blank(),
                                           axis.ticks =element_blank(),
                                           axis.text =element_blank(),
                                           axis.title = element_blank()) -> networkPlot
                        )
                      },
                      "degree-circle" = {
                        #构造数据标签的放置角度
                        number_of_bar<-nrow(Vertices1)
                        Vertices1$id<-seq(1, nrow(Vertices1))
                        angle<- 360 * (Vertices1$id-0.5) /number_of_bar
                        Vertices1$hjust<-ifelse(angle>180, 1, 0)
                        Vertices1$angle<-ifelse(angle>180, 90-angle+180, 90-angle)
                        mygraph <- igraph::graph_from_data_frame( Connect_data, vertices = Vertices1, directed = FALSE )
                        # 重新构造 graph 图结构的数据
                        ggraph(mygraph,layout = 'linear', circular = TRUE) +
                          ggraph::geom_edge_arc(aes(edge_colour=groupname), edge_alpha=1, edge_width=0.5,
                                                show.legend = FALSE) +
                          ggraph::geom_node_point(aes(size=MinusLog10P, fill=groupname), shape=21,
                                                  #alpha=0.9,
                                                  color='grey20') +
                          ggplot2::scale_size_continuous(range=c(0.5,10)) +
                          ggplot2::scale_fill_manual(values = ColorPre[[stringr::str_c(Brightness,"_",Palette)]][1:length(nodes.en$group %>% unique())])+
                          ggraph::geom_node_text(aes(x = x*1.09, y=y*1.09, label=label, angle=angle,hjust=hjust),
                                                 size=LabelSize,
                                                 show.legend = FALSE,
                                                 color='grey30') +
                          ggraph::scale_edge_color_manual(values = ColorPre[[stringr::str_c(Brightness,"_",Palette)]][1:length(nodes.en$group %>% unique())])+
                          ggplot2::labs(size = "MinusLog10P",
                                        fill = "Group")+
                          ggplot2::expand_limits(x = c(-1.6, 1.6), y = c(-1.6, 1.6))+
                          ggplot2::coord_fixed()+
                          ggplot2::theme_bw()+
                          ggplot2::theme(panel.grid = element_blank(),
                                         panel.border = element_blank(),
                                         axis.line = element_blank(),
                                         axis.ticks =element_blank(),
                                         axis.text =element_blank(),
                                         axis.title = element_blank()) -> networkPlot
                      }
               )

               eSet$MulOmics$NetWork$networkplot[["enet"]] <- gridExtra::marrangeGrob(list(networkPlot),
                                                                                      nrow = 1,ncol = 1,
                                                                                      top = title)
               # save --------------------------------------------------------------------
               ggplot2::ggsave(stringr::str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet/NetworkPlot_enet_",
                                              Layout,"_",Brightness,"_",Palette,".png"),
                               plot = eSet$MulOmics$NetWork$networkplot[["enet"]],
                               width =  20,
                               height = 20,
                               units = "cm")

               ggplot2::ggsave(stringr::str_c(Path,"/2_SG/Viz_InterOmic/ElasticNet/NetworkPlot_enet_",
                                              Layout,"_",Brightness,"_",Palette,".svg"),
                               plot = eSet$MulOmics$NetWork$networkplot[["enet"]],
                               width =  20,
                               height = 20,
                               units = "cm")

             }


             # rf--------------------------------------------------------
             if("rf" %in% SG_Lrns){
               nodes.rf$importance %>% abs() %>% quantile(probs = seq(0,1,0.2)) %>% .[2] -> labThr
               nodes.rf$importance %>% abs() %>% quantile(probs = seq(0,1,0.25)) %>% .[4] -> labThr2
               nodes.rf %<>%
                 mutate(labelsize = case_when(
                   abs(importance) >= labThr ~ 20,
                   abs(importance) < labThr ~ 0),
                   labelsize2 = case_when(
                     abs(importance) >= labThr2 ~ 20,
                     abs(importance) < labThr2 ~ 0))

               grDevices::colorRampPalette(c("white",
                                             mycolor[[stringr::str_c(Brightness,"_",Palette)]][3]))(4) %>%
                 .[[2]] -> plotcolor1
               grDevices::colorRampPalette(c("white",
                                             mycolor[[stringr::str_c(Brightness,"_",Palette)]][3]))(4) %>%
                 .[[4]] -> plotcolor2
               # node plot ---------------------------------------------------------------
               nodes.rf %>%
                 ggplot2::ggplot(aes(x=importance,y=MinusLog10P))+
                 ggplot2::geom_point(aes(size=MinusLog10P,shape=group,color=importance))+
                 ggplot2::scale_shape_manual(values = ggNdSp)+
                 ggplot2::scale_size_continuous("-Log10P")+
                 ggplot2::scale_color_gradient(low = plotcolor1,
                                               high = plotcolor2)+
                 ggrepel::geom_text_repel(data = subset(nodes.rf,
                                                        nodes.rf$labelsize2!=0),
                                          aes(label=id),
                                          box.padding = unit(0.5, "lines"),
                                          point.padding = unit(1, "lines"), segment.color = "grey50",
                                          show.legend = FALSE,max.overlaps = 20)+
                 ggplot2::labs(x = "Importance",
                               y="-Log10P",
                               shape = "Group",
                               color = "Importance")+
                 ggplot2::theme_bw()+
                 ggplot2::theme(panel.grid=element_blank()) -> NodePlot_rf

               eSet$MulOmics$NetWork$NodePlot[["rf"]] <- gridExtra::marrangeGrob(list(NodePlot_rf),
                                                                                 nrow = 1,ncol = 1,
                                                                                 top = title)

               # save node plot ----------------------------------------------------------
               ggplot2::ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/RandomForest/NodePlot_rf_",
                                                Brightness,"_",Palette,".png"),
                               plot = eSet$MulOmics$NetWork$NodePlot[["rf"]],
                               height = 6,
                               width = 8)

               ggplot2::ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/RandomForest/NodePlot_rf_",
                                                Brightness,"_",Palette,".svg"),
                               plot = eSet$MulOmics$NetWork$NodePlot[["rf"]],
                               height = 6,
                               width = 8)

               # delect duplicate edges --------------------------------------------------
               edges.rf %>%
                 dplyr::mutate(sourcename = str_remove(source,"E")) %>%
                 dplyr::mutate(targetname = str_remove(target,"E")) %>%
                 dplyr::mutate(sourcename = as.numeric(sourcename)) %>%
                 dplyr::mutate(targetname = as.numeric(targetname)) -> edges.rf

               func_CheckDuplicate <- function(x){
                 edges.rf %>%
                   dplyr::slice(x) %>%
                   dplyr::mutate(check1 = max(c(sourcename,targetname))) %>%
                   dplyr::mutate(check2 = min(c(sourcename,targetname)))-> rowuq
               }

               purrr::map_dfr(1:nrow(edges.rf),func_CheckDuplicate) %>%
                 dplyr::mutate(check = str_c(check1,"-",check2)) %>%
                 dplyr::distinct(check,.keep_all = TRUE) %>%
                 dplyr::select(-c(sourcename,targetname,check1,check2,check))-> edges.rf

               # prepare data ------------------------------------------------------------
               edges.rf %>%
                 dplyr::select(source,target,R) %>%
                 setNames(c("from","to","value")) -> connect_data

               nodes.rf$group %>% unique() -> OmicGroup

               rbind(
                 data.frame(from = "origin",
                            to = OmicGroup),
                 data.frame(to = unique(c(as.character(connect_data$to),as.character(connect_data$to)))) %>%
                   dplyr::left_join(nodes.rf %>%
                                      dplyr::select(id,group),
                                    by = c("to" = "id")) %>%
                   dplyr::arrange(group) %>%
                   setNames(c("to","from")) %>%
                   dplyr::select(from,to)
               ) -> Edges

               data.frame(
                 name = unique(c(as.character(Edges$from),as.character(Edges$to)))
               ) -> vertices_data

               vertices_data %<>%
                 dplyr::left_join(nodes.rf %>%
                                    dplyr::select(id,MinusLog10P,group),
                                  by = c("name" = "id")) %>%
                 dplyr::mutate(MinusLog10P = stringr::str_replace_na(MinusLog10P,replacement = "1")) %>%
                 setNames(c("name","value","groupname")) %>%
                 dplyr::mutate(value = as.numeric(value)) %>%
                 setNames(c("name","MinusLog10P","groupname"))

               vertices_data %<>%
                 dplyr::mutate(Group = Edges$from[ match( vertices_data$name, Edges$to ) ],
                               id = NA)
               Leaves <- which(is.na(match(vertices_data$name,Edges$from)))
               NLeaves <- length(Leaves)
               vertices_data$id[Leaves] <- seq(1:NLeaves)
               vertices_data$angle <- 90 - 360 * vertices_data$id / NLeaves
               vertices_data$hjust <- ifelse(vertices_data$angle < -90,1,0)
               vertices_data$angle <- ifelse(vertices_data$angle < -90,vertices_data$angle+180,
                                             vertices_data$angle)

               c(as.character(connect_data$from),as.character(connect_data$to)) %>%
                 as_tibble() %>%
                 dplyr::group_by(value) %>%
                 dplyr::summarize(n=n()) %>%
                 # dplyr::left_join(eSet$Expo$Voca %>%
                 #                    dplyr::select(SerialNo_Raw,
                 #                                  GroupName),by = c("value" = "SerialNo_Raw")) %>%
                 dplyr::left_join(nodes.rf %>%
                                    dplyr::select(id,label,group,MinusLog10P),
                                  by = c("value" = "id")) -> Vertices

               colnames(Vertices) <- c("name", "n","label","groupname","MinusLog10P")

               mygraph <- igraph::graph_from_data_frame( connect_data, vertices = Vertices, directed = FALSE )

               com <- igraph::walktrap.community(mygraph)

               Vertices1 <- Vertices %>%
                 dplyr::mutate( group = com$membership) %>%
                 dplyr::mutate(group=as.numeric(factor(group,
                                                       levels=sort(summary (as.factor(group)),index.return=TRUE,decreasing = T)$ix,
                                                       order=TRUE)))%>%
                 dplyr::filter( group<10) %>%
                 dplyr::arrange(group,desc(n)) %>%
                 dplyr::mutate(name=factor(name, name))

               Connect_data <- connect_data %>%
                 dplyr::filter(from %in% Vertices1$name) %>%
                 dplyr::filter(to %in% Vertices1$name) %>%
                 dplyr::left_join(Vertices1,by=c('from'='name'))


               mygraph <- igraph::graph_from_data_frame( Connect_data, vertices = Vertices1, directed = FALSE )
               #mycolor <- wesanderson::wes_palette("Darjeeling1", max(Vertices1$group), type = "continuous")

               # labelsize ---------------------------------------------------------------
               if(nrow(nodes.rf) <= 100){
                 LabelSize = 3
               }else if(nrow(nodes.rf) > 100 & nrow(nodes.rf) <= 300){
                 LabelSize = 2.5
               }else if(nrow(nodes.rf) >300 & nrow(nodes.rf) <= 450){
                 LabelSize = 2
               }else if(nrow(nodes.rf) >450 & nrow(nodes.rf) <= 600){
                 LabelSize = 1.5
               }else{
                 LabelSize = 1
               }
               # Plot --------------------------------------------------------------------
               switch(Layout,
                      "force-directed" = {
                        set.seed(123)
                        ddpcr::quiet(
                          ggraph::ggraph(mygraph,layout='fr') +
                            ggraph::geom_edge_link(edge_colour="grey50", edge_alpha=0.2, edge_width=0.3) +
                            ggraph::geom_node_point(ggplot2::aes(size=MinusLog10P, fill=groupname), shape=21,color='grey20',alpha=0.9) +
                            ggplot2::scale_size_continuous(range=c(0.5,10)) +
                            ggraph::geom_node_text(ggplot2::aes(label = label),
                                                   nudge_x = 0.12,
                                                   nudge_y = -0.12,
                                                   linewidth=LabelSize,
                                                   color="grey30") +
                            ggplot2::scale_fill_manual(values = ColorPre[[stringr::str_c(Brightness,"_",Palette)]][1:length(nodes.rf$group %>% unique())])+
                            ggplot2::expand_limits(x = c(-1.2, 1.2), y = c(-1.2, 1.2))+
                            ggplot2::theme_bw() +
                            ggplot2::labs(size = "MinusLog10P",
                                          fill = "Group")+
                            ggplot2::theme(panel.grid = element_blank(),
                                           axis.line = element_blank(),
                                           axis.ticks =element_blank(),
                                           axis.text =element_blank(),
                                           axis.title = element_blank()) -> networkPlot
                        )
                      },
                      "degree-circle" = {
                        #构造数据标签的放置角度
                        number_of_bar<-nrow(Vertices1)
                        Vertices1$id<-seq(1, nrow(Vertices1))
                        angle<- 360 * (Vertices1$id-0.5) /number_of_bar
                        Vertices1$hjust<-ifelse(angle>180, 1, 0)
                        Vertices1$angle<-ifelse(angle>180, 90-angle+180, 90-angle)
                        mygraph <- igraph::graph_from_data_frame( Connect_data, vertices = Vertices1, directed = FALSE )
                        # 重新构造 graph 图结构的数据
                        ggraph(mygraph,layout = 'linear', circular = TRUE) +
                          ggraph::geom_edge_arc(aes(edge_colour=groupname), edge_alpha=1, edge_width=0.5,
                                                show.legend = FALSE) +
                          ggraph::geom_node_point(aes(size=MinusLog10P, fill=groupname), shape=21,
                                                  #alpha=0.9,
                                                  color='grey20') +
                          ggplot2::scale_size_continuous(range=c(0.5,10)) +
                          ggplot2::scale_fill_manual(values = ColorPre[[stringr::str_c(Brightness,"_",Palette)]][1:length(nodes.rf$group %>% unique())])+
                          ggraph::geom_node_text(aes(x = x*1.09, y=y*1.09, label=label, angle=angle,hjust=hjust),
                                                 size=LabelSize,
                                                 show.legend = FALSE,
                                                 color='grey30') +
                          ggraph::scale_edge_color_manual(values = ColorPre[[stringr::str_c(Brightness,"_",Palette)]][1:length(nodes.rf$group %>% unique())])+
                          ggplot2::labs(size = "MinusLog10P",
                                        fill = "Group")+
                          ggplot2::expand_limits(x = c(-1.6, 1.6), y = c(-1.6, 1.6))+
                          ggplot2::coord_fixed()+
                          ggplot2::theme_bw()+
                          ggplot2::theme(panel.grid = element_blank(),
                                         panel.border = element_blank(),
                                         axis.line = element_blank(),
                                         axis.ticks =element_blank(),
                                         axis.text =element_blank(),
                                         axis.title = element_blank()) -> networkPlot
                      }
               )

               eSet$MulOmics$NetWork$networkplot[["rf"]] <- gridExtra::marrangeGrob(list(networkPlot),
                                                                                    nrow = 1,ncol = 1,
                                                                                    top = title)
               # save --------------------------------------------------------------------
               ggplot2::ggsave(stringr::str_c(Path,"/2_SG/Viz_InterOmic/RandomForest/NetworkPlot_rf_",
                                              Layout,"_",Brightness,"_",Palette,".png"),
                               plot = eSet$MulOmics$NetWork$networkplot[["rf"]],
                               width =  20,
                               height = 20,
                               units = "cm")

               ggplot2::ggsave(stringr::str_c(Path,"/2_SG/Viz_InterOmic/RandomForest/NetworkPlot_rf_",
                                              Layout,"_",Brightness,"_",Palette,".svg"),
                               plot = eSet$MulOmics$NetWork$networkplot[["rf"]],
                               width =  20,
                               height = 20,
                               units = "cm")

             }


             # xgb--------------------------------------------------------
             if("xgboost" %in% SG_Lrns){
               nodes.xgb$importance %>% abs() %>% quantile(probs = seq(0,1,0.2)) %>% .[2] -> labThr
               nodes.xgb$importance %>% abs() %>% quantile(probs = seq(0,1,0.25)) %>% .[4] -> labThr2
               nodes.xgb %<>%
                 dplyr::mutate(labelsize = case_when(
                   abs(importance) >= labThr ~ 20,
                   abs(importance) < labThr ~ 0),
                   labelsize2 = case_when(
                     abs(importance) >= labThr2 ~ 20,
                     abs(importance) < labThr2 ~ 0))

               grDevices::colorRampPalette(c("white",
                                             mycolor[[stringr::str_c(Brightness,"_",Palette)]][3]))(4) %>%
                 .[[2]] -> plotcolor1
               grDevices::colorRampPalette(c("white",
                                             mycolor[[stringr::str_c(Brightness,"_",Palette)]][3]))(4) %>%
                 .[[4]] -> plotcolor2

               # node plot ---------------------------------------------------------------
               nodes.xgb %>%
                 ggplot2::ggplot(aes(x=importance,y=MinusLog10P))+
                 ggplot2::geom_point(aes(size=MinusLog10P,shape=group,color=importance))+
                 ggplot2::scale_shape_manual(values = ggNdSp)+
                 ggplot2::scale_size_continuous("-Log10P")+
                 ggplot2::scale_color_gradient(low = plotcolor1,
                                               high = plotcolor2)+
                 ggrepel::geom_text_repel(data = subset(nodes.xgb,
                                                        nodes.xgb$labelsize2!=0),
                                          aes(label=id),
                                          box.padding = unit(0.5, "lines"),
                                          point.padding = unit(1, "lines"), segment.color = "grey50",
                                          show.legend = FALSE,max.overlaps = 20)+
                 ggplot2::labs(x = "Importance",
                               y="-Log10P",
                               shape = "Group",
                               color = "Importance")+
                 ggplot2::theme_bw()+
                 ggplot2::theme(panel.grid=element_blank()) -> NodePlot_xgb

               eSet$MulOmics$NetWork$NodePlot[["xgboost"]] <- gridExtra::marrangeGrob(list(NodePlot_xgb),
                                                                                      nrow = 1,ncol = 1,
                                                                                      top = title)

               # save node plot ----------------------------------------------------------
               ggplot2::ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Xgboost/NodePlot_xgboost_",
                                                Brightness,"_",Palette,".png"),
                               plot = eSet$MulOmics$NetWork$NodePlot[["xgboost"]],
                               height = 6,
                               width = 8)

               ggplot2::ggsave(filename = str_c(Path,"/2_SG/Viz_InterOmic/Xgboost/NodePlot_xgboost_",
                                                Brightness,"_",Palette,".svg"),
                               plot = eSet$MulOmics$NetWork$NodePlot[["xgboost"]],
                               height = 6,
                               width = 8)

               # delect duplicate edges --------------------------------------------------
               edges.xgb %>%
                 dplyr::mutate(sourcename = str_remove(source,"E")) %>%
                 dplyr::mutate(targetname = str_remove(target,"E")) %>%
                 dplyr::mutate(sourcename = as.numeric(sourcename)) %>%
                 dplyr::mutate(targetname = as.numeric(targetname)) -> edges.xgb

               func_CheckDuplicate <- function(x){
                 edges.xgb %>%
                   dplyr::slice(x) %>%
                   dplyr::mutate(check1 = max(c(sourcename,targetname))) %>%
                   dplyr::mutate(check2 = min(c(sourcename,targetname)))-> rowuq
               }

               purrr::map_dfr(1:nrow(edges.xgb),func_CheckDuplicate) %>%
                 dplyr::mutate(check = str_c(check1,"-",check2)) %>%
                 dplyr::distinct(check,.keep_all = TRUE) %>%
                 dplyr::select(-c(sourcename,targetname,check1,check2,check))-> edges.xgb

               # prepare data ------------------------------------------------------------
               edges.xgb %>%
                 dplyr::select(source,target,R) %>%
                 setNames(c("from","to","value")) -> connect_data

               nodes.xgb$group %>% unique() -> OmicGroup

               rbind(
                 data.frame(from = "origin",
                            to = OmicGroup),
                 data.frame(to = unique(c(as.character(connect_data$to),as.character(connect_data$to)))) %>%
                   dplyr::left_join(nodes.xgb %>%
                                      dplyr::select(id,group),
                                    by = c("to" = "id")) %>%
                   dplyr::arrange(group) %>%
                   setNames(c("to","from")) %>%
                   dplyr::select(from,to)
               ) -> Edges

               data.frame(
                 name = unique(c(as.character(Edges$from),as.character(Edges$to)))
               ) -> vertices_data

               vertices_data %<>%
                 dplyr::left_join(nodes.xgb %>%
                                    dplyr::select(id,MinusLog10P,group),
                                  by = c("name" = "id")) %>%
                 dplyr::mutate(MinusLog10P = stringr::str_replace_na(MinusLog10P,replacement = "1")) %>%
                 setNames(c("name","value","groupname")) %>%
                 dplyr::mutate(value = as.numeric(value)) %>%
                 setNames(c("name","MinusLog10P","groupname"))

               vertices_data %<>%
                 dplyr::mutate(Group = Edges$from[ match( vertices_data$name, Edges$to ) ],
                               id = NA)
               Leaves <- which(is.na(match(vertices_data$name,Edges$from)))
               NLeaves <- length(Leaves)
               vertices_data$id[Leaves] <- seq(1:NLeaves)
               vertices_data$angle <- 90 - 360 * vertices_data$id / NLeaves
               vertices_data$hjust <- ifelse(vertices_data$angle < -90,1,0)
               vertices_data$angle <- ifelse(vertices_data$angle < -90,vertices_data$angle+180,
                                             vertices_data$angle)

               c(as.character(connect_data$from),as.character(connect_data$to)) %>%
                 as_tibble() %>%
                 dplyr::group_by(value) %>%
                 dplyr::summarize(n=n()) %>%
                 # dplyr::left_join(eSet$Expo$Voca %>%
                 #                    dplyr::select(SerialNo_Raw,
                 #                                  GroupName),by = c("value" = "SerialNo_Raw")) %>%
                 dplyr::left_join(nodes.xgb %>%
                                    dplyr::select(id,label,group,MinusLog10P),
                                  by = c("value" = "id")) -> Vertices

               colnames(Vertices) <- c("name", "n","label","groupname","MinusLog10P")

               mygraph <- igraph::graph_from_data_frame( connect_data, vertices = Vertices, directed = FALSE )

               com <- igraph::walktrap.community(mygraph)

               Vertices1 <- Vertices %>%
                 dplyr::mutate( group = com$membership) %>%
                 dplyr::mutate(group=as.numeric(factor(group,
                                                       levels=sort(summary (as.factor(group)),index.return=TRUE,decreasing = T)$ix,
                                                       order=TRUE)))%>%
                 dplyr::filter( group<10) %>%
                 dplyr::arrange(group,desc(n)) %>%
                 dplyr::mutate(name=factor(name, name))

               Connect_data <- connect_data %>%
                 dplyr::filter(from %in% Vertices1$name) %>%
                 dplyr::filter(to %in% Vertices1$name) %>%
                 dplyr::left_join(Vertices1,by=c('from'='name'))


               mygraph <- igraph::graph_from_data_frame( Connect_data, vertices = Vertices1, directed = FALSE )
               #mycolor <- wesanderson::wes_palette("Darjeeling1", max(Vertices1$group), type = "continuous")

               # labelsize ---------------------------------------------------------------
               if(nrow(nodes.xgb) <= 100){
                 LabelSize = 3
               }else if(nrow(nodes.xgb) > 100 & nrow(nodes.xgb) <= 300){
                 LabelSize = 2.5
               }else if(nrow(nodes.xgb) >300 & nrow(nodes.xgb) <= 450){
                 LabelSize = 2
               }else if(nrow(nodes.xgb) >450 & nrow(nodes.xgb) <= 600){
                 LabelSize = 1.5
               }else{
                 LabelSize = 1
               }
               # Plot --------------------------------------------------------------------
               switch(Layout,
                      "force-directed" = {
                        set.seed(123)
                        ddpcr::quiet(
                          ggraph::ggraph(mygraph,layout='fr') +
                            ggraph::geom_edge_link(edge_colour="grey50", edge_alpha=0.2, edge_width=0.3) +
                            ggraph::geom_node_point(ggplot2::aes(size=MinusLog10P, fill=groupname), shape=21,color='grey20',alpha=0.9) +
                            ggplot2::scale_size_continuous(range=c(0.5,10)) +
                            ggraph::geom_node_text(ggplot2::aes(label = label),
                                                   nudge_x = 0.12,
                                                   nudge_y = -0.12,
                                                   size=LabelSize,
                                                   color="grey30") +
                            ggplot2::scale_fill_manual(values = ColorPre[[stringr::str_c(Brightness,"_",Palette)]][1:length(nodes.xgb$group %>% unique())])+
                            ggplot2::expand_limits(x = c(-1.2, 1.2), y = c(-1.2, 1.2))+
                            ggplot2::theme_bw() +
                            ggplot2::labs(size = "MinusLog10P",
                                          fill = "Group")+
                            ggplot2::theme(panel.grid = element_blank(),
                                           axis.line = element_blank(),
                                           axis.ticks =element_blank(),
                                           axis.text =element_blank(),
                                           axis.title = element_blank()) -> networkPlot
                        )
                      },
                      "degree-circle" = {
                        #构造数据标签的放置角度
                        number_of_bar<-nrow(Vertices1)
                        Vertices1$id<-seq(1, nrow(Vertices1))
                        angle<- 360 * (Vertices1$id-0.5) /number_of_bar
                        Vertices1$hjust<-ifelse(angle>180, 1, 0)
                        Vertices1$angle<-ifelse(angle>180, 90-angle+180, 90-angle)
                        mygraph <- igraph::graph_from_data_frame( Connect_data, vertices = Vertices1, directed = FALSE )
                        # 重新构造 graph 图结构的数据
                        ggraph(mygraph,layout = 'linear', circular = TRUE) +
                          ggraph::geom_edge_arc(aes(edge_colour=groupname), edge_alpha=1, edge_width=0.5,
                                                show.legend = FALSE) +
                          ggraph::geom_node_point(aes(size=MinusLog10P, fill=groupname), shape=21,
                                                  #alpha=0.9,
                                                  color='grey20') +
                          ggplot2::scale_size_continuous(range=c(0.5,10)) +
                          ggplot2::scale_fill_manual(values = ColorPre[[stringr::str_c(Brightness,"_",Palette)]][1:length(nodes.xgb$group %>% unique())])+
                          ggraph::geom_node_text(aes(x = x*1.09, y=y*1.09, label=label, angle=angle,hjust=hjust),
                                                 size=LabelSize,
                                                 show.legend = FALSE,
                                                 color='grey30') +
                          ggraph::scale_edge_color_manual(values = ColorPre[[stringr::str_c(Brightness,"_",Palette)]][1:length(nodes.xgb$group %>% unique())])+
                          ggplot2::labs(size = "MinusLog10P",
                                        fill = "Group")+
                          ggplot2::expand_limits(x = c(-1.6, 1.6), y = c(-1.6, 1.6))+
                          ggplot2::coord_fixed()+
                          ggplot2::theme_bw()+
                          ggplot2::theme(panel.grid = element_blank(),
                                         panel.border = element_blank(),
                                         axis.line = element_blank(),
                                         axis.ticks =element_blank(),
                                         axis.text =element_blank(),
                                         axis.title = element_blank()) -> networkPlot
                      }
               )

               eSet$MulOmics$NetWork$networkplot[["xgboost"]] <- gridExtra::marrangeGrob(list(networkPlot),
                                                                                         nrow = 1,ncol = 1,
                                                                                         top = title)
               # save --------------------------------------------------------------------
               ggplot2::ggsave(stringr::str_c(Path,"/2_SG/Viz_InterOmic/Xgboost/NetworkPlot_xgboost_",
                                              Layout,"_",Brightness,"_",Palette,".png"),
                               plot = eSet$MulOmics$NetWork$networkplot[["xgboost"]],
                               width =  20,
                               height = 20,
                               units = "cm")

               ggplot2::ggsave(stringr::str_c(Path,"/2_SG/Viz_InterOmic/Xgboost/NetworkPlot_xgboost_",
                                              Layout,"_",Brightness,"_",Palette,".svg"),
                               plot = eSet$MulOmics$NetWork$networkplot[["xgboost"]],
                               width =  20,
                               height = 20,
                               units = "cm")

             }
             return(eSet)
           }
           VizAllNetGgraph(eSet,
                           Layout = Layout,
                           Brightness = Brightness,
                           Palette = Palette)
         })

  # save
  eSet$RCommandLog <- eSet$AddCommand(stringr::str_c("eSet<-VizMulOmics(eSet = eSet,",
                                                     "VarsY='targetVarsY',",
                                                     "NodeNum=",NodeNum,",",
                                                     "EdgeThr=",EdgeThr,",",
                                                     "Layout='",Layout,"',",
                                                     "Brightness='",Brightness,"',",
                                                     "Palette='",Palette,"'"))
  eSet$RCommandLog %>%
    as_tibble() %>%
    purrr::set_names("R commands") %>%
    data.table::fwrite(stringr::str_c(eSet$FileDirOut,"/rcommands log.txt"))

  eSet$ExcecutionLog %>%
    as_tibble() %>%
    purrr::set_names("running log") %>%
    data.table::fwrite(stringr::str_c(eSet$FileDirOut,"/running log.txt"))

  eSet %>%
    save(file = str_c(eSet$FileDirOut,"/eSet.Rdata"))

  tictoc::toc()

  return(eSet)
}
